%%%%%%%%%%%%%%%%%%%%%definitions%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{../../doc/related_pages/header.tex}
\input{../../doc/related_pages/newcommands.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%DOCUMENT%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{The feltor project}
\author{ M.~Held and M.~Wiesenberger}
\maketitle

\begin{abstract}
This is a program for global 3d isothermal electrostatic full-F gyro-fluid simulations.
\end{abstract}

\section{The model}
\subsection{Dimensional Equations}
% \(n_e\) is the electron density, \(N_i\) is the ion gyro-centre density, \(\phi\) is the electric potential,
% \\
% This model is an isothermal 3D gyro-fluid model, which exploits the toroidal field line approximation in the curvature operator terms (cf.~\ref{sec:torfieldlineapprox}).
% It incorporates a Solov'ev equilibrium (cf.~\ref{sec:solovev}) for the magnetic field, which allows a
% realistically shaped axisymmetric magnetic field. The coordinate system of choice is a non-aligned  cylindrical coordinate system (cf.~\ref{sec:cylmetric} and~\ref{sec:nonparallelalignedmetric}), which allows
% the correct numerical treatment of singular points (e.g. X- and O- Points). These points occur naturally in realistic magnetic field configurations.
% Since it is based on a global geometry, treating the complete poloidal flux surface, it is suited for coupled simulations of core, edge and SOL.
% However, our isothermal model misses important core physics ingredients, such as the ion temperature gradient (ITG) and trapped electron mode (TEM)~\cite{Wesson07}. Thus the validity the global model is limited to certain
% parameter regimes.\\
The continuity equations for the electron density \(n_e\) and  ion gyro-centre density electrons  \(N_i\) read
\begin{align}
 \frac{\partial}{\partial t}n_e =&
 - \frac{1}{B}\left[\phi,  n_e \right]_{\perp}
 -  {\nabla}_{\parallel}( n_e u_e)
 + n_e u_e   {\nabla}_{\parallel} \ln{(B)}
+ \frac{t_e }{e }  \mathcal{K} \left( n_e\right)
\nonumber  \\ &
-   n_e \mathcal{K}(\phi)
%  + \frac{m_e }{ e } n_e u_e \mathcal{K} \left(  u_e \right)
%  + \frac{m_e }{2 e } u_e^2 \mathcal{K} \left(n_e \right) +
   +  \frac{m_e }{ e } \mathcal{K}_{\kappa} \left( n_e u_e^2 \right)
   + \frac{m_e }{ e } \left( n_e u_e^2 \right) \vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
   + \Lambda_{n_e} + S_{n_e},\\
\frac{\partial}{\partial t}N_i =&
 - \frac{1}{B}\left[\psi_i,  N_i \right]_{\perp}
 - {\nabla}_{\parallel}(N_i U_i)
 + N_i U_i   {\nabla}_{\parallel} \ln{(B)}
- \frac{T_i }{e }  \mathcal{K} \left( N_i\right)
\nonumber  \\ &
-   N_i \mathcal{K}(\psi)
%  - \frac{m_i }{ e } N_i U_i \mathcal{K} \left(  U_i \right)
%  - \frac{m_i }{2 e } U_i^2 \mathcal{K} \left(N_i \right) +
- \frac{m_i }{ e }\mathcal{K}_{\kappa}  \left( N_i U_i^2 \right)
- \frac{m_i }{ e } \left( N_i U_i^2 \right)\vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
+ \Lambda_{N_i} + S_{N_i}.
\end{align}
The evolution equation for the parallel electron velocity \(u_e\) and the parallel ion gyro-centre velocity \(U_i\) are
\begin{align}
\frac{\partial}{\partial t}  u_e
      =&
      - \frac{1 }{ B} \left[ \phi, u_e  \right]_{\perp}
      +  \frac{e}{m_e}   \nabla_\parallel \phi
      -   \frac{1}{2}   \nabla_\parallel u_e^2
      - \frac{t_e}{m_e } \nabla_\parallel \ln  n_e
     - u_e   \mathcal{K}_{\kappa} \left( \phi  \right)
     + \frac{t_e}{e} \mathcal{K}\left(  u_e \right)
     \nonumber  \\    &
%      + \frac{m_e  u_e^2}{ e} \mathcal{K}_{\kappa} \left(u_e\right)
%     + \frac{2  t_e}{ e} \mathcal{K}_{\kappa} \left(u_e\right)
     + \frac{1}{e} \left(m_e  u_e^2 +  2  t_e\right)\mathcal{K}_{\kappa} \left(u_e\right)
    + \frac{2  t_e u_e }{ e} \mathcal{K}_{\kappa} \left(\ln n_e \right)
    + \frac{t_e  u_e }{e} \vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
%      +\frac{  t_e u_e }{e }  \mathcal{K}\left( \ln n_e \right)
%       +\left(\frac{2  t_e  }{e} + \frac{m_e  u_e^2}{2 e} \right) \mathcal{K} \left(u_e\right)
%       +\frac{e}{m_e}   \eta_{\parallel} J_\parallel
    +\Lambda_{u_e} + R_{e, \eta_\parallel},  \\
\frac{\partial}{\partial t}    U_i
      =&
      - \frac{1 }{ B} \left[ \psi_i, U_i  \right]_{\perp}
      -  \frac{e}{m_i}   \nabla_\parallel \psi_i
      -     \frac{1}{2}  \nabla_\parallel U_i^2
      - \frac{T_i}{m_i } \nabla_\parallel \ln  N_i
     -  U_i  \mathcal{K}_{\kappa} \left( \psi_i  \right)
     - \frac{T_i}{e} \mathcal{K}\left(  U_i \right)
     \nonumber  \\    &
%            - \frac{m_i  U_i^2}{ e} \mathcal{K}_{\kappa} \left(U_i\right)
%            - \frac{2  T_i}{ e} \mathcal{K}_{\kappa} \left(U_i\right)
           - \frac{1}{e}\left(m_i  U_i^2 + 2  T_i \right) \mathcal{K}_{\kappa} \left(U_i\right)
           - \frac{2  T_i U_i }{ e} \mathcal{K}_{\kappa} \left(\ln N_i \right)
           - \frac{T_i  U_i }{e} \vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
%      -\frac{  T_i U_i }{e }  \mathcal{K}\left( \ln N_i \right)
%       -\left(\frac{2  T_i  }{e} + \frac{m_i  U_i^2}{2 e} \right) \mathcal{K} \left(U_i\right)
%       -\frac{e}{m_i}   \eta_{\parallel} J_\parallel
           +\Lambda_{U_i} + R_{i,\eta_\parallel} .
\end{align}
The electric potential \(\phi\) is computed by the polarisation equation
\begin{align}
  n_e -\Gamma_{1,i} N_i &= \vec{\nabla} \cdot\left(\frac{N_i}{\Omega_i B} \vec{\nabla}_\perp \phi\right),
  \label{eq:polarisation_dimensional}
\end{align}
and with the generalised electric potential
\begin{align}
  \psi_i&:= \Gamma_{1,i} \phi - \frac{m u_E^2}{2 q}, \quad \Gamma_{1,i}^{-1} := 1-\frac{m_i T_i}{2q^2 B_0^2} \nabla_\perp^2
\end{align}
The perpendicular Poisson bracket, the perpendicular \(\nabla_\perp\) and parallel derivative \(\nabla_\parallel\),
and the perpendicular \(\Delta_\perp\) and parallel Laplacian \(\Delta_\parallel\) are
\begin{align}\label{eq:perppoiss}
 \left[f,g\right]_\perp &:= \bhat \cdot \left(\vec{\nabla} f \times \vec\nabla g\right) =
    b_i \varepsilon^{ijk}\partial_j f\partial_k g/\sqrt{g}, \\
 \vec \nabla_\perp f &:= \bhat\times(\vec \nabla f\times \bhat ) \equiv
    h \cdot \nabla f, \quad h^{ij} := g^{ij} - b^ib^j\\
 \nabla_\parallel f&:= \bhat\cdot\vec{\nabla} f ,\\
 \Delta_\perp f&:= \nabla_\perp^2 f:= \vec \nabla\cdot (\vec \nabla_\perp f)
    = \nabla\cdot( h\cdot\nabla f),  \\
 \Delta_\parallel f&:= \vec{\nabla} \cdot ( \bhat\bhat\cdot\vec{\nabla} f ),
\end{align}
with $b^i$ the contra- and $b_i$ the co-variant components of $\bhat$,
$\eps^{ijk}$ the Levi-Civita symbols
and the curvature operators
\begin{align}\label{eq:curvopgen}
  \mathcal K_\kappa(f) &:= \vec{ \mathcal K_\kappa }\cdot \vec \nabla f = \frac{1}{B}(\nabla \times \bhat)\cdot \vec \nabla f \\
  \mathcal K_{\nabla B}(f) &:= \vec{\mathcal K_{\nabla B}} \cdot \vec \nabla f = \frac{1}{B}(\bhat \times \vec \nabla \ln B)\cdot \vec \nabla f \\
  \mathcal{K}(f)&:=\vec{\mathcal K} \cdot \vec \nabla f = \vec{\nabla} \cdot \left(\frac{ \bhat \times \vec{\nabla} f}{B} \right) = \mathcal K_\kappa(f) + \mathcal K_{\nabla B}(f),\\
  \vec \nabla \cdot \vec{\mathcal K_\kappa} &= -\vec\nabla \cdot \vec{\mathcal K_{\nabla B}} = -\mathcal K_\kappa(\ln B)
  ,\quad \vec\nabla\cdot\vec{ \mathcal K} = 0.
\end{align}
Explicit expressions of the perpendicular Poisson bracket \( \frac{1}{B}\left[f,g\right]_\perp\), the perpendicular elliptic operator \( \vec{\nabla}\cdot\left(g \vec{\nabla}_\perp f\right)\),
the parallel derivative \(\nabla_\parallel\) and the parallel Laplacian \(\Delta_\parallel\) and  the curvature operators \(\mathcal{K}(f)\),
\(\mathcal{K}_\kappa(f)\) and \(\vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa} \)
depend on the choice of the magnetic field geometry, curvature approximation and the underlying coordinate system.
\subsection{Parallel Resistivity, diffusion, profiles and particle sources}\label{sec:dissres}
The terms $R_{e/i,\eta_\parallel}$ account for resistive friction.
The parallel Spitzer resistivity
\begin{align}
\eta_\parallel := \frac{0.51 m_e \nu_{ei}}{n_e e^2}
\end{align}
and the approximate Spitzer current \(J_{\parallel,s}:= e n_e \left(U_i - u_e\right)\) determine the parallel resistive terms to:
\begin{align}
  R_{e,\eta_\parallel} &=  en_e\eta_\parallel J_{\parallel,s}/(m_en_e)  &
  R_{i,\eta_\parallel} &=- en_e\eta_\parallel J_{\parallel,s}/(m_iN_i)
\end{align}
The dissipative terms can be decomposed into perpendicular and parallel components
\begin{align}
 \Lambda_{n_e} &= \Lambda_{n_e,\perp}+\Lambda_{n_e,\parallel}, &
 \Lambda_{N_i} &= \Lambda_{N_i,\perp}+\Lambda_{N_i,\parallel},\\
 \Lambda_{u_e} &= \Lambda_{u_e,\perp}+\Lambda_{u_e,\parallel},&
 \Lambda_{U_i} &= \Lambda_{U_i,\perp}+\Lambda_{U_i,\parallel}.
\end{align}
For numerical stabilisation we choose:
\begin{align}
\Lambda_{n_e,\parallel} &=  \nu_\parallel\vec{\nabla} \cdot \left(\bhat \nabla_\parallel n_e\right) &
 \Lambda_{N_i,\parallel} &=  \nu_\parallel\vec{\nabla} \cdot \left(\bhat \nabla_\parallel N_i\right) \\
  \Lambda_{u_e,\parallel} &= \nu_\parallel \vec{\nabla} \cdot \left(\bhat \nabla_\parallel u_e\right) &
 \Lambda_{U_i,\parallel} &= \nu_\parallel \vec{\nabla} \cdot \left(\bhat \nabla_\parallel U_i\right) 
\end{align}
Similarly for the perpendicular dissipation we apply hyperviscous terms of second order.
\begin{align}\label{eq:perpdiffNT}
 \Lambda_{n_e,\perp} &=  -\nu_\perp \vec{\nabla}_\perp^4 n_e &
 \Lambda_{N_i,\perp} &=  -\nu_\perp \vec{\nabla}_\perp^4 N_i &
 \Lambda_{u_e,\perp} &=  -\nu_\perp \vec{\nabla}_\perp^4 u_e &
 \Lambda_{U_i,\perp} &=  -\nu_\perp \vec{\nabla}_\perp^4 U_i
\end{align}
Here the mass diffusion coefficient coincides with the viscous coefficient, hence we fixed the Schmidt number \(\mathit{Sc}_\parallel:= \frac{\nu_U}{\nu_N}\) to unity.

The idea for the source terms $S$ is to fix a profile in the core of our domain
where our model does not apply.
Let us define an approximate Heaviside function with the help of the flux function $\psi_p$ (defined later in Section~\ref{sec:magnetic})
\begin{align}
  \Theta(R,Z) := \frac{1}{2}\left( 1 + \tanh\left( - \frac{\psi_p(R,Z) - \psi_{p,min} + 3\alpha}{\alpha} \right) \right)
  \label{eq:source_profile}
\end{align}
with a (small) width parameter $\alpha$
and a density profile as
\begin{align}
  N_{prof}(R,Z)=\begin{cases}
    N_{bg} + N_{peak}\frac{\psi_p(R,Z)} {\psi_p(R_0, 0)} \text{ if }\psi_p < \psi_{p,max} \\
    N_{bg} \text{ else }
  \end{cases}
  \label{eq:density_profile}
\end{align}
We then define the particle source for electrons as
\begin{align}
  S_{n_e}(R,Z) = s\begin{cases}
    \Theta(R,Z)(N_{prof}(R,Z) - n_e(R,Z)) &\text{ if } n_e(R,Z)<N_{prof}(R,Z)\\
    0 &\text{ else}
  \end{cases}
  \label{eq:electron_source}
\end{align}
where $s$ is the source strength parameter.
For ions we use
\begin{align}
    S_{N_i} = \Gamma_{1,i}^{-1} S_{n_e}
  \label{eq:ion_source}
\end{align}
Note that Eq.~\eqref{eq:ion_source} is explicitly chosen as to avoid vorticity generation
by the particle source (cf.~Section~\ref{sec:conservation}).

\subsection{Boundary and Initial conditions}
We apply Dirichlet boundary conditions to the parallel velocity and potential
\begin{align}
u_e = U_i = \phi = \psi = 0
\end{align}
For the densities we can choose between Neumann and Dirichlet boundaries
\begin{align}
n_e = N_i = 1, \text{ or } \hat n \cdot \nabla n_e = \hat n \cdot \nabla N_i = 0
\end{align}
where $\hat n$ is the normal vector to the boundary.

We initialize the parallel velocitiy to zero
\begin{align}
  u_e = U_i = 0
  \label{}
\end{align}
We have two possibilities to initialize the densities
\begin{align}
  n_e = \Gamma_{1,i} N_i \text{ or } n_e = N_i
  \label{}
\end{align}
In the first case the potential $\phi= 0$ while in the second case
the $E\times B$ and ion diamagnetic vorticity coincide $\Delta N_i ~ \Delta \phi$.
We start with initializing in an $R$-$Z$ plane
\begin{align}
  N_i(R,Z,\varphi)= N_{prof}(R,Z)
  \label{}
\end{align}
We then add one of the following initial perturbations to the ion gyrocenter density
\subsubsection{Blob and Straight blob}
We initialize a blob in the R-Z plane
\begin{align}
  N_{blob}(R,Z) = \triangle n \exp\left( \frac{(R - R_0 - p_x a)^2 + (Z-p_ya)^2}{\sigma^2} \right)
  \label{}
\end{align}
Then, we use fieldline integration to transform this blob to all other poloidal planes. In this way the parallel derivative $\nabla_\parallel N$ is zero in the beginning.
We either follow fieldlines around the torus several times (``blob'') or only once
(``straight blob'').
\subsubsection{Turbulent bath}
We can initialize the R-Z plane with a turbulent bath with a certain amplitude.
Again, we transform this to all poloidal planes along the magnetic field lines.
\subsubsection{Zonal flows}
We can initialize the R-Z plane with zonal flows of amplitude $A$ and wavelength $k_\psi$ aligned with the magnetic flux surfaces.
Again, we transform this to all poloidal planes along the magnetic field lines.

\subsection{Conservation laws} \label{sec:conservation}
\subsubsection{Mass conservation}
Integrating the density equation we directly get
\begin{align}
  \frac{\partial}{\partial t} \int d\vec{x} n_e =  - \int d\vec{x} (\Lambda_{n_e}+S_{n_e})
\end{align}
\subsubsection{Charge/vorticity conservation}
Integrating the polarisation equation~\eqref{eq:polarisation_dimensional}
\begin{align}
  \frac{\partial}{\partial t} \int d\vec{x} \vec{\nabla} \cdot\left(\frac{N_i}{\Omega_i B} \vec{\nabla}_\perp \phi\right) =  - \int d\vec{x} (\Lambda_{n_e} - \Gamma_{1,i}\Lambda_{N_i} + S_{n_e} - \Gamma_{1,i}S_{N_i})
\end{align}
Note that if the integrand on the left hand side is interpreted as the \ExB vorticity
density
$\zeta := \nabla\cdot( N_i\nabla_\perp/\Omega_i B)$
and if we further assume that $\Gamma_{1,i} \Lambda_{N_i} \equiv \Lambda_{\Gamma_{1,i}N_i}$, and insert the ion source term~\eqref{eq:ion_source}
we get the vorticity conservation
\begin{align}
  \frac{\partial}{\partial t} \int d\vec{x} \zeta =  - \int d\vec{x}\Lambda_{\zeta}
  \label{}
\end{align}

\subsubsection{Energy theorem}
The terms of the energy theorem are derived to
\begin{align}
  \mathcal{E}= \int  d\vec{x} & \left( t_e n_e \ln{(n_e)} +T_i N_i\ln{(N_i)}+  \frac{1}{2} m_i N_i u_E^2 +\frac{1}{2} m_e  n_e u_e^2 +\frac{1}{2} m_i  N_i U_i^2  \right),\\
  \Lambda =  \int d\vec{x} & \bigg\{  \left[t_e\left( 1+\ln{(n_e)}\right) -e \phi + \frac{1}{2} m_e u_e^2 \right](\Lambda_{n_e} + S_{n_e})
  \nonumber\\ &
+\left[T_i\left( 1+\ln{(N_i)}\right) +e \psi_i + \frac{1}{2} m_i U_i^2 \right](\Lambda_{N_i}+S_{N_i})
\nonumber \\ &
+ m_e u_e n_e \Lambda_{u_e}+m_iU_i N_i \Lambda_{U_i} - \eta_\parallel J_{\parallel,s}^2\bigg\}.
\end{align}
The energy consists of the Helmholtz free energy density for electrons and ions, the \(\vec{E} \times \vec{B}\) energy density, the parallel energy densities for electrons and ions and the perturbed magnetic field energy density.
In \(\Lambda\) we insert the dissipative terms of Section~\ref{sec:dissres}. \\
\subsection{Dimensionless form}
We scale all spatial lengths by $\rho_s = \sqrt{T_e m_i}/(eB_0)$ and time by the ion gyrofrequency $\Omega_0 = eB_0/m_i$.
The magnetic field is scaled with $B_0$, densities with $n_0$ and the parallel velocity is scaled with $c_s = \sqrt{T_e/m_i}$.
Furthermore, we introduce the dimensionless parameters
\begin{align}
  \tau_a = \frac{T_a}{z_aT_e} \text{ and } \mu_a = \frac{m_a}{z_am_i}
  \label{}
\end{align}
where $a\in\{e,i\}$ is the species label and $z$ is the charge number. Finally, we define
\begin{align}
  \eta:=\frac{en_0\eta_\parallel}{B_0} = 8.45\cdot 10^{-5}\ln \lambda \left(\frac{n_0}{10^{19}\text{m}^3}\right) \left(\frac{T_e}{\text{eV}}\right)^{-3/2} \left(\frac{B_0}{\text{T}}\right)^{-1}.
    \label{eq:resistivity}
\end{align}
Omitting the species label we arrive at (dividing the density equation by $\Omega_0n_0$ and the velocity equation by $\Omega_0 c_s$)
\begin{subequations}
    \begin{align}
    \frac{\partial}{\partial t} N =&
        - \frac{1}{B}[\psi, N]_{\perp}%\nonumber\\
        - \nabla_\parallel \left( NU\right)
        + NU\nabla_\parallel\ln(B)
        - \tau \mathcal K(N) \nonumber \\&
        - N \mathcal K(\psi)
        -\mu \mathcal K_\kappa(NU^2)
        -\mu NU^2\nabla\cdot \vec{ \mathcal K_\kappa}
        - \nu_\perp\Delta_\perp^2 N + \nu_\parallel \Delta_\parallel N + S_N, \\
    \frac{\partial}{\partial t} U =&
        - \frac{1}{B}\left[\psi, U\right]_{\perp}%& \nonumber\\
        - \frac{1}{\mu} \nabla_\parallel \psi% \nonumber\\
        - \frac{1}{2}\nabla_\parallel U^2
        -\frac{\tau}{\mu} \nabla_\parallel \ln N
        - U\mathcal K_\kappa(\psi)
        - \tau \mathcal K(U)
        -\tau U\nabla\cdot\vec{ \mathcal K_\kappa}\nonumber\\&
        - \left(2\tau + {\mu}U^2\right) \mathcal K_\kappa (U)
        -2\tau U\mathcal K_\kappa(\ln N)
        - \frac{\eta}{\mu} \frac{n_e}{N}n_e(U_i - u_e)
        - \nu_\perp\Delta_\perp^2 U + \nu_\parallel \Delta_\parallel U ,
        \label{eq:EgyrofluidU}
    \end{align}
    \label{eq:Egyrofluid}
\end{subequations}
together with
  \begin{align}
    -\nabla\cdot\left( \frac{N_i}{B^2}\nabla_\perp \phi \right) &= \Gamma_{1,i} N_i - n_e, \quad\quad
    \Gamma_{1,i}^{-1} = 1-\frac{1}{2}\tau_i\mu_i \nabla_\perp^2
  \end{align}
The energy theorem reads
\begin{align}
  \mathcal{E}= \int  d\vec{x} & \left( z_e\tau_e n_e \ln{(n_e)} +z_i\tau_i N_i\ln{(N_i)}+  \frac{1}{2} \mu_i N_i u_E^2 +\frac{1}{2} z_e\mu_e  n_e u_e^2 +\frac{1}{2} z_i\mu_i  N_i U_i^2  \right),\\
  \Lambda =  \int d\vec{x} & \bigg\{  z_e\left[\tau_e\left( 1+\ln{(n_e)}\right) + \phi + \frac{1}{2} \mu_e u_e^2 \right](\Lambda_{n_e} + S_{n_e})
  \nonumber\\ &
+z_i\left[\tau_i\left( 1+\ln{(N_i)}\right) + \psi_i + \frac{1}{2} \mu_i U_i^2 \right](\Lambda_{N_i}+S_{N_i})
\nonumber \\ &
+ z_e\mu_e u_e n_e \Lambda_{u_e}+z_i\mu_iU_i N_i \Lambda_{U_i} - \eta J_{\parallel,s}^2\bigg\}.
\end{align}

\subsection{Coordinate system}\label{sec:cylmetric}
We employ cylindrical coordinates \( (R,Z,\varphi) \), with \(\varphi\) anti directed to the geometric toroidal angle to
obtain a right handed system. The parametric representation in Cartesian \((x,y,z)\) coordinates is therefore simply:
\begin{align}
 x &= R \hspace{1 mm} \sin{(\varphi)}, &
 y &= R \hspace{1 mm} \cos{(\varphi)}, &
 z &= Z .
\end{align}
Covariant
basis vectors and metric tensor:
\begin{align}
 \vec{e}_R      &= (\sin{(\varphi)} ,   \cos{(\varphi)},0)^T, &
 \vec{e}_Z      &= ( 0 ,0 ,1 )^T, &
 \vec{e}_{\varphi} &= R ( \cos{(\varphi)} , -\sin{(\varphi)} , 0 )^T,
\\
 g &= \begin{pmatrix}
  1 & 0 & 0 \\
  0 & 1 & 0 \\
  0 & 0 & R^2
   \end{pmatrix}
% \vec{\nabla} R &= (\sin{(\varphi)} ,   \cos{(\varphi)},0 )^T , &
%  \vec{\nabla}Z &= ( 0 ,0 ,1 )^T,  &
%  \vec{\nabla}{\varphi} &= \frac{1}{R} ( \cos{(\varphi)} , -\sin{(\varphi)} , 0 )^T .
\end{align}
With the help of the metric elements we get a well behaved volume element \(\sqrt{g} = R\). However, we have a coordinate singularity at \(R=0\).
The cylindrical coordinate basis vectors are mutually orthogonal to each other.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The magnetic field}\label{sec:magnetic}
There are two choices for the magnetic field, purely toroidal or
the more general
toroidal-poloidal magnetic field. Even though the first is a special
case of the latter we treat it seperately since many terms in the
equations simplify of vanish.
\subsection{The toroidal field}\label{sec:toroidal}
One choice is a purely toroidal magnetic field of the form %($I(\psi)=\psi=1$) 
\begin{align}
  \vec B(R) := \frac{R_0}{R} \ehat_\varphi
  \label{}
\end{align}
We then have $\bhat = \ehat_\varphi$ and $\vec\kappa = -\frac{1}{R}\ehat_R$. The curvature operators simplify to
\begin{align}
  \vec{ \mathcal K_\kappa} &= \vec{ \mathcal K_{\nabla B}} = -\frac{1}{R_0} \ehat_Z \\
\vec{ \mathcal K} &= -\frac{2}{R_0}\ehat_Z
  \label{}
\end{align}
We have
\begin{subequations}
\begin{align}
    [f, g]_\perp &= (\partial_R f\partial_Z g - \partial_R g\partial_Z f) \equiv [f, g]_{RZ}, \\
    \nabla \cdot(\nabla_\perp f) &= \frac{1}{R}\partial_R\left(R\partial_R f\right) + \partial_Z^2f
    \label{}
\end{align}
\end{subequations}
Note that $\nabla\cdot\vec{\mathcal K_{\kappa}}= 0$ and $\nabla_\parallel \ln B = 0$.
Also note that the identification of $x:=R-R_0$ and the transition to
Cartesian coordinates while straightening the field lines for large $R_0$
lead to the familiar slab geometry.

\subsection{Solov'ev equilbrium}\label{sec:solovev}
In cylindrical coordinates the general axisymmetric magnetic field normalized with $R_0$ can be rewritten to
\begin{align}
 \vec{B} &= \frac{R_0I(\psi)}{R} \ehat_{\varphi} + \frac{R_0}{R}\left[\frac{\partial \psi}{\partial Z} \ehat_R 
         -  \frac{\partial \psi}{\partial R} \ehat_Z\right] ,
\end{align}
which can obviously not be manipulated to be in Clebsch form. Hence we are dealing with a non-flux aligned coordinate system.
For the sake of clarity we define the poloidal magnetic field \( \vec{B}_p = \frac{R_0}{R}\left( \frac{\partial \psi}{\partial Z}\ehat_R - \frac{\partial \psi}{\partial R}\ehat_Z\right)
\) and the toroidal magnetic field \(\vec{B}_t =\frac{R_0I}{R} \ehat_{\varphi}\).
The unit vectors are denoted by \(\ehat_{R}\), \(\ehat_{Z}\), \(\ehat_{\varphi}\). Note that $B^R=B_R$ and $B^Z=B_Z$ whereas
$B^\varphi = R_0I/R^2$ and $B_\varphi=R_0I$ (contra- and covariant components of $\vec B$).
By construction we have $\partial_\varphi B = 0$ with
\begin{align}
  B = \frac{R_0}{R}\sqrt{ {I^2 + |\nabla \psi_p|^2}}.
    \label{}
\end{align}
Furthermore, we have
\begin{align}
  \nabla_\parallel f(R,Z) = \frac{R_0}{RB}[f,\psi_p]_{RZ}\Rightarrow \nabla_\parallel \ln B = \frac{R_0}{RB^2}\left[B, \psi_p\right]_{RZ} = -\vec\nabla\cdot\bhat.
    \label{}
\end{align}
%%%%%%%%%%%%%%%%%%%%%%%%%

Let us state the Grad-Shafranov equation
\begin{align}\label{eq:GSEdimless}
 \Delta^*_\perp  \psi_p &= -R^2 \frac{d p}{d  \psi_p } - I \frac{d I}{d  \psi_p }\equiv - R j_\varphi.
\end{align}
Note that $R$ and $Z$ are normalized
with $\rho_s$, $\psi_p$ with $\psi_{p0}$, $p$ with
$p_0 := \psi_{p0}^2/\mu_0\rho_s^4$, $I$ with $I_0:=\psi_{p0}/\rho_s$,
and $j_\varphi$ with $\j_{\varphi 0} = \psi_{p0}/\rho_s^3\mu_0$.
The Solov'ev assumptions consist of \(A/R_0 = -I \frac{d I}{d  \psi_p }\) and \((1-A)/R_0^3 = -\frac{d p}{d  \psi_p }\), where \(A\) is a constant~\cite{Cerfon2010,Cerfon2014}.
By integration over \(\psi_p\) we find
\begin{align}\label{eq:solovevassumption}
 p(\psi_p) &= (A-1)\psi_p/R_0^3,  &
 I(\psi_p) &= \sqrt{-2 A \psi_p/R_0 + 1}, &
 j_\varphi &= \left[(A-1)R - A R_0^2 / R\right]/R_0^3.
\end{align}
Now, we introduce \(\bar{R} \equiv \frac{R}{R_0}\) and \(\bar{Z} \equiv\frac{Z}{R_0}\)
and solve Equations~\eqref{eq:GSEdimless} and~\eqref{eq:solovevassumption} to obtain
\begin{align}
 \psi_p (R,Z) &= R_0 \left[ \frac{1}{8}\bar{R}^4 + A\left( \frac{1}{2} \bar{R}^2 \ln{\bar{R}} 
   - \frac{1}{8}\bar{R}^4\right) + \sum_{i=1}^{12} c_{i}  \bar{\psi}_{pi}\right],
\end{align}
with
\rowcolors{2}{gray!25}{white}
\begin{longtable}{>{\RaggedRight}p{7cm}>{\RaggedRight}p{7cm}}
\toprule
  $\bar{\psi}_{p1}=1$
  & $\bar{\psi}_{p7}=8\bar{Z}^6 -140 \bar{R}^2 \bar{Z}^4
                      + 75 \bar{R}^4 \bar{Z}^2 - 15\bar{R}^6\ln{\bar{R}}+ 180 \bar{R}^4 \bar{Z}^2 \ln{\bar{R}} \
                       -120 \bar{R}^2 \bar{Z}^4 \ln{\bar{R}}$\\
%
  $\bar{\psi}_{p2}=\bar{R}^2$ &
  $\bar{\psi}_{p8}=\bar{Z}$ \\
%
  $\bar{\psi}_{p3}=\bar{Z}^2 - \bar{R}^2 \ln{\bar{R}}$ &
  $\bar{\psi}_{p9}=\bar{Z}  \bar{R}^2$\\
%
  $\bar{\psi}_{p4}=\bar{R}^4 -4\bar{R}^2\bar{Z}^2$ &
  $\bar{\psi}_{p10}=\bar{Z}^3 - 3 \bar{Z} \bar{R}^2 \ln{\bar{R}}$\\
  %
  $\bar{\psi}_{p5}=2\bar{Z}^4 - 9 \bar{R}^2\bar{Z}^2 + \
                     3 \bar{R}^4 \ln{\bar{R}} \
                    -12  \bar{R}^2\bar{Z}^2 \ln{\bar{R}}$
  &
$\bar{\psi}_{p11}=3 \bar{Z}\bar{R}^4 - 4\bar{Z}^3\bar{R}^2$\\
%
  $\bar{\psi}_{p6}=\bar{R}^6 -12 \bar{R}^4 \bar{Z}^2
                     + 8  \bar{R}^2 \bar{Z}^4$ &
  $\bar{\psi}_{p12}= 8 \bar{Z}^5 -45 \bar{Z} \bar{R}^4 - \
                       80 \bar{Z}^3 \bar{R}^2\ln{\bar{R}} \
                       +60 \bar{Z} \bar{R}^4\ln{\bar{R}}$ \\
   & \\
\bottomrule
\end{longtable}
The choice of the coefficients \(c_{i}\) and \(A\) determines the actual form of the magnetic field. It allows axisymmetric equilibria with e.g. single and asymmetric double X-point configurations, force-free states,
field reversed configurations and low and high beta tokamak equilbria. This casts this simple analytical equilibrium to the ideal choice in order to study geometric effects (e.g. inverse aspect ratio, elongation and triangularity) in magnetised plasmas.

However, we allow to make simplifications to the curvature operator
for the Solov'ev equilibrium.

\subsubsection{Toroidal field line approximation}\label{sec:torfieldlineapprox}
The toroidal field line approximation applies \(\bhat\approx \ehat_\varphi\) to all perpendicular operators (e.g.: Poisson bracket, perpendicular elliptic operator and curvature operators)
but retains the full expression for the magnetic field unit vector \(\bhat\)
for parallel operators (\(\nabla_\parallel\) and \(\Delta_\parallel\)).
Hence the curvature reduces in cylindrical coordinates \((R,Z,\varphi)\) to
% In low beta plasmas \(\beta\ll1\) the curvature (Equation~\eqref{eq:kappagen}) reduces to:
\begin{align}\label{eq:kappalowbeta}
 \nabla\times\bhat &\approx -  \frac{1}{R} \ehat_Z.
\end{align}
This simplifies the curvature operators to:
\begin{align}
\vec{\mathcal{K}}_{\kappa}  &\approx  -  \frac{1}{B R} \ehat_Z , &
\vec{ \mathcal{K} }_{\vec{\nabla}  B}  &\approx  -\frac{1}{B^2}\frac{\partial B}{\partial Z}\ehat_R +\frac{1}{B^2} \frac{\partial B}{\partial R}\ehat_Z &
%\ehat_\varphi \times \vec{\nabla} B, &
\vec{ \mathcal{K} } &\approx \vec{ \mathcal{K} }_{\vec{\nabla}  B}  +\vec{ \mathcal{K} }_{\kappa} ,
%\\
%\mathcal{K}_{\kappa}(f)   &\approx  -  \frac{1}{B R} \frac{\partial f}{\partial Z},&
%\mathcal{K}_{\vec{\nabla}  B} (f)  &= \frac{1}{B} \left[\ln B, f \right]_{RZ},&
%\mathcal{K} (f) &\approx\frac{1}{B} \left[\ln B, f \right]_{RZ}-  \frac{1}{B R} \frac{\partial f}{\partial Z} ,
\end{align}
and
\begin{align}
 \vec{\nabla} \cdot \vec{\mathcal{K}}_{\kappa} &\approx \frac{1}{R B^2} \frac{\partial B}{\partial Z}.
\end{align}
This results in a vanishing divergence of the curvature operators \( \vec{\nabla} \cdot \vec{ \mathcal{K} } = 0\), which is an important property for energetic consistency.

\subsubsection{Low beta approximation}\label{sec:lowbetaapprox}
In this approximation we approximate the curvature operator $\mathcal K_\kappa \approx \bhat\times\kappa$.
  with
  $\vec \kappa := \bhat \cdot \vec \nabla\bhat = -\bhat \times(\vec \nabla\times \bhat)$.
For an isotropic pressure plasma \(\vec{P} = \vec{I} P_\perp + \vec{b} \vec{b} P_\Delta \approx \vec{I} P_\perp\) and with the definition of the plasma beta parameter
\(\beta = \frac{P}{B^2/(2 \mu_0) } \)
we can rewrite the curvature to
\begin{align}
 \vec{\kappa} &\approx \frac{\beta}{2} \vec{\nabla} \ln(P) +\vec{\nabla}_\perp \ln{B} .
\end{align}
In low beta plasmas \(\beta\ll1\) the curvature reduces to:
\begin{align}\label{eq:kappalowbeta}
 \vec{\kappa} & \approx \vec{\nabla}_\perp \ln{B} .
\end{align}
This simplifies the curvature operators to:
\begin{align}
\mathcal{K}_{\kappa}(f)   &\approx  \mathcal{K}_{\vec{\nabla}  B}(f),  &
\mathcal{K} (f) &\approx 2\mathcal{K}_{\vec{\nabla}  B} (f) , &
 \vec{\kappa} \cdot \vec{\mathcal{K}}_{\vec{\nabla}  B} &= 0.
\end{align}
The divergence over the curvature vanishes \( \vec{\nabla} \cdot \vec{ \mathcal{K} } = 0\) only if \( \vec{\nabla} \cdot \vec{ \mathcal{K}}_{\vec{\nabla}  B}   = 0\).
The divergence \( \vec{\nabla} \cdot \vec{ \mathcal{K} } \approx 0\) is only approximately vanishing.
\subsubsection{True curvature terms}
Without any approximations we have
\begin{align}
b^R = {\frac{\partial \psi}{\partial Z}}\left(I^2+|\nabla\psi|^2\right)^{-1/2} \quad
b^Z = -{\frac{\partial \psi}{\partial R}}\left(I^2+|\nabla\psi|^2\right)^{-1/2} \quad 
b^\varphi = \frac{I}{R}\left(I^2+|\nabla\psi|^2\right)^{-1/2} \\
\vec\nabla\cdot\bhat = -\nabla_\parallel \ln B = -\frac{R_0}{R B^2}[B,\psi_p]_{RZ}
\label{}
\end{align}
We can then explicitly write
\begin{align}
K_{\nabla B}^R &= -\frac{R_0 I}{B^3R}\frac{\partial B}{\partial Z} \equiv -\frac{1}{B^2}\frac{\partial B}{\partial Z}b^\varphi \\
K_{\nabla B}^Z &= \frac{R_0 I}{B^3R}\frac{\partial B}{\partial R}\equiv \frac{1}{B^2}\frac{\partial B}{\partial R}b^\varphi \\
K_{\nabla B}^\varphi &= \frac{1}{B^3R^2}\left(\frac{\partial\psi}{\partial Z} \frac{\partial B}{\partial Z} + \frac{\partial \psi}{\partial R}\frac{\partial B}{\partial R}\right)
%\equiv \frac{1}{B^2R}\left(\bhat^R \frac{\partial B}{\partial Z} - \bhat^Z \frac{\partial B}{\partial R}\right)\quad %contravariant phi component
\label{}
\end{align}
and
\begin{align}
K_\kappa^R &= \frac{R_0 }{RB^2}\left( \frac{\partial I}{\partial Z} -\frac{I}{B}\frac{\partial B}{\partial Z}\right) \\
K_\kappa^Z &= \frac{R_0 }{RB^2} \left( \frac{I}{B}\frac{\partial B}{\partial R} - \frac{\partial I}{\partial R} \right)\\
K_\kappa^\varphi &= \frac{1}{R^2B^2}\left(
+ \frac{1}{B}\frac{\partial\psi}{\partial Z} \frac{\partial B}{\partial Z}
+ \frac{1}{B}\frac{\partial \psi}{\partial R}\frac{\partial B}{\partial R}
-\frac{1}{R}\frac{\partial}{\partial R}\left(\frac{1}{R}\frac{\partial\psi}{\partial R}\right) 
- \frac{\partial^2 \psi}{\partial Z^2}
\right) \\
\vec\nabla\cdot\vec{\mathcal K_\kappa} &= -\vec\nabla\cdot\vec{\mathcal K_{\nabla B}}= -\vec{\mathcal K_\kappa}\cdot \vec \nabla\ln B = \frac{R_0}{RB^3}[I,B]_{RZ}
%contravariant phi component
\label{}
\end{align}
Furthermore, we write
\begin{align}
(\nabla_\perp f)^i = (g^{ij}-b^ib^j)\partial_j f =: h^{ij}\partial_j f
\label{}
\end{align}
where we defined the projection tensor $h$, which is positive semi-definite.
Finally, we have
\begin{align}
[f,g]_\perp := \bhat \cdot(\nabla f\times\nabla g) =
 \frac{1}{\sqrt{g}}\left(
 b_R [f,g]_{Z\varphi}
 + b_Z [f,g]_{\varphi R} 
 + b_\varphi [f,g]_{RZ}
 \right)
\label{}
\end{align}
where $[f,g]_{ij} = \partial_i f\partial_jg - \partial_j f\partial_i g$.
\section{Numerical methods}
discontinuous Galerkin on structured grid
\rowcolors{2}{gray!25}{white} %%% Use this line in front of longtable
\begin{longtable}{ll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Term} &  \textbf{Method} & \textbf{Description}  \\ \midrule
    coordinate system & Cylindrical 3D & equidistant discretization of $[0,l_R] \times [0,l_Z] \times [0,2\pi]$, equal number of Gaussian nodes in R and Z, in $\varphi$ equidistant \\
matrix inversions & multigrid/ conjugate gradient & Use previous two solutions to extrapolate initial guess and $1/\chi$ as preconditioner \\
Parallel derivative & refined  FCI & cf.~\cite{Held2016,Stegmeir2017} \\
Parallel diffusion & refined FCI & cf.~\cite{Held2016,Stegmeir2017} \\
drift terms & direct & cf. curvature approximations \\
time & Adaptive ARKode stepper & $3rd$ order explicit, diffusion $3rd$ order implicit \\
\bottomrule
\end{longtable}

\subsection{Input file structure}
Input file format: json

%%This is a booktabs table
\begin{longtable}{llll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Example} & \textbf{Default} & \textbf{Description}  \\ \midrule
n      & integer & 3 & - &\# Gaussian nodes in R and Z \\
Nx     & integer &52& - &\# grid points in R \\
Ny     & integer &52& - &\# grid points in Z \\
Nz     & integer &16& - &\# grid points in $\varphi$ \\
dt     & integer &1e-2& - &initial time step in units of $c_s/\rho_s$ \\
compressionX & integer & 2 & 1 & output contains n*Nx/compressionX points in x,
    has to divde Nx evenly\\
compressionY & integer & 2 & 1 & output contains n*Ny/compressionY points in y,
    has to divde Ny evenly\\
itstp  & integer & 2  & - & steps between outputs \\
maxout & integer & 10 & - & \# outputs excluding first \\
eps\_pol   & float &1e-5    & - &  accuracy of polarisation solver \\
jumpfactor & float &1& - &     jumpfactor $\in \left[0.01,1\right]$ in Elliptic\\
eps\_gamma & float &1e-6    & - & accuracy of $\Gamma_1$  \\
eps\_time  & float &1e-9   & - & accuracy of solver for implicit part in time-stepper \\
rtol  & float &1e-6   & - &tolerance of adaptive time-stepper \\
stages      & integer & 3 & 3 & \# stages in multigrid  \\
mx     & integer & 10 & 10 & refinement factor in DS in X-direction\\
my     & integer & 10 & 10 & refinement factor in DS in Y-direction\\
mu         & float & -0.00272121& - & $\mu_e :=-m_e/m_i \in \left\{ -0.000544617, -0.000272121, -0.000181372 \right\}$\\
tau        & float &1      & - & $\tau = T_i/T_e$  \\
nu\_perp   & float &1e-3   & - & pependicular viscosity $\nu_\perp$ \\
nu\_parallel & float &1e-1 & - & parallel viscosity $\nu_\parallel$ \\
resistivity & float &1e-4  & - & parallel resistivity parameter~\eqref{eq:resistivity}\\
amplitude  & float &0.01   & - & amplitude $A$ of initial perturbation \\
sigma      & float &2      & - & blob variance in units of $\rho_s$ \\
posX       & float &0.3    & - & blob x-position in units of $a$\\
posY       & float &0.0    & - & blob y-position in units of $a$ \\
sigma\_z    & float &0.25   & - & variance in units of $R_0$  \\
k\_psi     & float &0    & - & zonal mode wave number  \\
nprofileamp& float &4   & - & Profile peak amplitude $N_{peak}$ in Eq.~\eqref{eq:density_profile} \\
bgprofamp  & float &1   & - & Background Prof amplitude $N_{bg}$ in Eq.~\eqref{eq:density_profile} (density on the boundary) \\
bcx     & char & "DIR"      & - & perpendicular BC for parallel derivative \\
bcy     & char & "DIR"      & - & perpendicular BC for parallel derivative \\
    source  & float & 0     & - & profile source rate $s$ in Eq.~\eqref{eq:electron_source} \\
boxscaleRp  & float & 1.1     & 1.05 & $R_+$ a little larger than 1\\
boxscaleRm  & float & 1.1     & 1.05 & $R_-$ a little larger than 1 \\
boxscaleZp  & float & 1.1     & 1.05 & $Z_+$ a little larger than 1 \\
boxscaleZm  & float & 1.2     & 1.05 & $Z_-$ a little larger than 1 \\
pollim    & bool & false     & false & poloidal limiter (true/false) \\
initni    & string & "turbulence"     & "blob"  & initial condition for ion gyro-centre density "zonal",
    "blob" = blob simulations (several rounds fieldaligned),
    "straight blob" = straight blob simulation( 1 round fieldaligned),
    "turbulence" = turbulence simulations ( 1 round fieldaligned)\\
initphi   & string & "zero"  & "zero" & initial condition in phi "zero" = 0 electric potential, "balance" = ExB vorticity equals ion diamagnetic vorticity \\
curvmode  & string & "low beta"  & "toroidal"& curvature approximation ("low beta", "true", "toroidal") \\
\bottomrule
\end{longtable}
The default value is taken if the value name is not found in the input file. If there is no default and
the value is not found,
the program exits with an error message.
\subsection{Geometry file structure}
File format: json

%%This is a booktabs table
\begin{longtable}{llll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Example} & \textbf{Default} & \textbf{Description}  \\ \midrule
    A      & float & 1 &  - & Solovev parameter \\
    R\_0   & float & - & -  & Major radius in $\rho_s$ \\
    C      & float[12] &  - & - & Solovev coefficients \\
    elongation & float & 1 & - & Elongation \\
    triangularity & float & 0 & - & Triangularity \\
    inverseaspectratio & float & 0.16667 & - & $a/R_0$ \\
    alpha  & float & 0.02 & - & Width of Heaviside profile in Eq.~\eqref{eq:source_profile} \\
    psip\_min & float & -6 & - & $\psi_{p,min}$ in Heaviside profile Eq.~\eqref{eq:source_profile} \\
    psip\_max & float & 0 & - & $\psi_{p,max}$ in density profile Eq.~\eqref{eq:density_profile} \\
    psip\_max\_lim & float & 1e10 & - & $\psi_p$ for limiter in DS \\
    rk4eps & float & 0.01 & - & Accuracy of fieldline integration in DS \\
\bottomrule
\end{longtable}
The default value is taken if the value name is not found in the input file. If there is no default and
the value is not found,
the program exits with an error message.


%..................................................................
\bibliography{../../doc/related_pages/references}
%..................................................................


\end{document}
