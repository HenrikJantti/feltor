%%%%%%%%%%%%%%%%%%%%%definitions%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{../../doc/related_pages/header.tex}
\input{../../doc/related_pages/newcommands.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%DOCUMENT%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{The feltor project}
\author{ M.~Held and M.~Wiesenberger}
\maketitle

\begin{abstract}
The full-F electromagnetic model in toroidal geoemtry (\textsc{Feltor}).
This is a program for global 3d isothermal electromagnetic full-F gyro-fluid simulations.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The magnetic field}\label{sec:magnetic}
Let us assume a three-dimensional flat space with arbitrary coordinate
system $\vec x :=\{x_0, x_1, x_2\}$, metric
tensor $g_{ij}$ and volume element $\sqrt{g} := \sqrt{\det g}$.
Given a vector field $\vec B(\vec x)$ with unit vector $\bhat := \vec B/B$
we can define various differential operations.
Let us further assume that $\bhat$ is perturbed by the parallel
vector potential $A_\parallel$ via
$\tilde{ \vec b } := ({\nabla \times A_\parallel \bhat)}/{B}$
\rowcolors{2}{gray!25}{white}
%\begin{longtable}{>{\RaggedRight}p{7cm}>{\RaggedRight}p{7cm}}
\begin{longtable}{lll>{\RaggedRight}p{7cm}}
%\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Symbol} & \textbf{Definition} \\
\midrule
    Perpendicular Poisson bracket&
    $\left[.,.\right]_\perp$ &
    $\left[f,g\right]_\perp := \bhat \cdot \left(\vec{\nabla} f \times \vec\nabla g\right) =
    b_i \varepsilon^{ijk}\partial_j f\partial_k g/\sqrt{g}$  \\
    Projection Tensor&
    $h $ & $h^{ij} := g^{ij} - b^ib^j $\\
    %Alignment Tensor&
    %$t $ & $ t^{ij} := b^ib^j$\\
    Perpendicular Gradient&
    $\vec \nabla_\perp $&
    $ \vec \nabla_\perp f := \bhat\times(\vec \nabla f\times \bhat ) \equiv
    h \cdot \nabla f$ \\
    Perpendicular Laplacian&
    $\Delta_\perp $&
    $ \Delta_\perp f:= \vec \nabla\cdot (\vec \nabla_\perp f)
    = \nabla\cdot( h\cdot\nabla f)$  \\
    Curl-b Curvature &
    $\mathcal K_\kappa$ &
    $\mathcal K_\kappa(f) := \vec{ \mathcal K_\kappa }\cdot \vec \nabla f = \frac{1}{B}(\nabla \times \bhat)\cdot \vec \nabla f$ \\
    Grad-B Curvature &
    $\mathcal K_{\nabla B} $ &
    $\mathcal K_{\nabla B}(f) := \vec{\mathcal K_{\nabla B}} \cdot \vec \nabla f = \frac{1}{B}(\bhat \times \vec \nabla \ln B)\cdot \vec \nabla f$ \\
    Curvature &
    $\mathcal K$ &
    $\mathcal{K}(f):=\vec{\mathcal K} \cdot \vec \nabla f = \vec{\nabla} \cdot \left(\frac{ \bhat \times \vec{\nabla} f}{B} \right) = \mathcal K_\kappa(f) + \mathcal K_{\nabla B}(f)$,\\
    Parallel derivative&
    $\nabla_\parallel $&
    $ \nabla_\parallel f := \bhat\cdot\vec{\nabla} f$ \\
    Perturbed parallel Derivative&
    $\bar\nabla_\parallel$ &
    $\bar\nabla_\parallel f := (\bhat + \tilde{\vec b })\cdot \nabla f = \nabla_\parallel f + A_\parallel \mathcal K_\kappa(f) + \frac{1}{B}[ f, A_\parallel]_\perp$ \\
    Parallel Laplacian&
    $\Delta_\parallel $&
    $\Delta_\parallel f:= \vec{\nabla} \cdot ( \bhat\bhat\cdot\vec{\nabla} f )$\\
\bottomrule
\end{longtable}
with $b^i$ the contra- and $b_i$ the co-variant components of $\bhat$, and 
$\eps^{ijk}$ the Levi-Civita symbols.
Explicit expressions for the above expressions
depend on the choice of the magnetic field and the underlying coordinate system.
    Note that we have
\begin{align}
    \vec \nabla \cdot \vec{\mathcal K_\kappa}
    &= -\vec\nabla \cdot \vec{\mathcal K_{\nabla B}} = -\vec{ \mathcal K_\kappa}\cdot\nabla\ln B, \\
    \vec\nabla\cdot\vec{ \mathcal K} &= 0, \\
    \vec{ \mathcal K_\kappa} - \vec{ \mathcal K_{\nabla B}} &= \frac{1}{B^2} (\vec \nabla \times \vec B).
    \label{eq:curl_curvature}
\end{align}
and
\begin{align}
\bar\nabla_\parallel \ln B &= \nabla_\parallel \ln B - A_\parallel \vec \nabla\cdot\vec{ \mathcal{ K_\kappa}} + \mathcal K_{\nabla B}(A_\parallel) = -\vec\nabla\cdot(\bhat + \tilde{\vec b})
\end{align}
The last equality holds if $\vec\nabla\cdot \vec B = 0$.
Note that in any arbitrary coordinate system we have
\begin{align}
(\vec \nabla f)^i = g^{ij}\partial_j f ~, \quad
\vec \nabla \cdot \vec v = \frac{1}{\sqrt{g}}\partial_i \left(\sqrt{g} v^i\right) ~, \quad
(\vec v \times \vec w)^i = \frac{1}{\sqrt{g}}\varepsilon^{ijk} v_jw_k ~.
%\label{}
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coordinate system}\label{sec:cylmetric}
We employ cylindrical coordinates \( (R,Z,\varphi) \), with \(\varphi\) anti directed to the geometric toroidal angle to
obtain a right handed system. The parametric representation in Cartesian \((x,y,z)\) coordinates is therefore simply:
\begin{align}
 x &= R \hspace{1 mm} \sin{(\varphi)}, &
 y &= R \hspace{1 mm} \cos{(\varphi)}, &
 z &= Z .
\end{align}
Covariant
basis vectors and metric tensor:
\begin{align}
 \ehat_R      &= (\sin{(\varphi)} ,   \cos{(\varphi)},0)^T, &
 \ehat_Z      &= ( 0 ,0 ,1 )^T, &
 \ehat_{\varphi} &= R ( \cos{(\varphi)} , -\sin{(\varphi)} , 0 )^T,
\\
 g &= \begin{pmatrix}
  1 & 0 & 0 \\
  0 & 1 & 0 \\
  0 & 0 & R^2
   \end{pmatrix}
% \vec{\nabla} R &= (\sin{(\varphi)} ,   \cos{(\varphi)},0 )^T , &
%  \vec{\nabla}Z &= ( 0 ,0 ,1 )^T,  &
%  \vec{\nabla}{\varphi} &= \frac{1}{R} ( \cos{(\varphi)} , -\sin{(\varphi)} , 0 )^T .
\end{align}
With the help of the metric elements we get a well behaved volume element \(\sqrt{g} = R\). However, we have a coordinate singularity at \(R=0\).
The cylindrical coordinate basis vectors are mutually orthogonal to each other.

\subsection{Solov'ev equilbrium}\label{sec:solovev}
In cylindrical coordinates the general axisymmetric magnetic field normalized with $R_0$ can be written as
\begin{align}
 \vec{B} &= \frac{R_0I(\psi)}{R} \ehat_{\varphi} + \frac{R_0}{R}\left[\frac{\partial \psi}{\partial Z} \ehat_R 
         -  \frac{\partial \psi}{\partial R} \ehat_Z\right] ,
\end{align}
which can obviously not be manipulated to be in Clebsch form. Hence we are dealing with a non-flux aligned coordinate system.
For the sake of clarity we define the poloidal magnetic field \( \vec{B}_p = \frac{R_0}{R}\left( \frac{\partial \psi}{\partial Z}\ehat_R - \frac{\partial \psi}{\partial R}\ehat_Z\right)
\) and the toroidal magnetic field \(\vec{B}_t =\frac{R_0I}{R} \ehat_{\varphi}\).
%The unit vectors are denoted by \(\ehat_{R}\), \(\ehat_{Z}\), \(\ehat_{\varphi}\).
Note that with $\psi_p = I(\psi_p) \equiv 1$ we recover a purely toroidal field.
With a subsequent identification of $x:=R-R_0$ and the transition to
Cartesian coordinates while straightening the field lines for large $R_0$
we recover the familiar slab geometry.


Let us state the Grad-Shafranov equation
\begin{align}\label{eq:GSEdimless}
 -\Delta^*_\perp  \psi_p &= R^2 \frac{d p}{d  \psi_p } + I \frac{d I}{d  \psi_p }\equiv R j_\varphi.
\end{align}
with $\Delta^*_\perp \psi_p = R\partial_R (R^{-1}\psi_R) + \psi_{ZZ}$.
Note that $R$ and $Z$ are normalized
with $\rho_s$, $\psi_p$ with $\psi_{p0}$, $p$ with
$p_0 := \psi_{p0}^2/\mu_0\rho_s^4$, $I$ with $I_0:=\psi_{p0}/\rho_s$,
and $j_\varphi$ with $\j_{\varphi 0} = \psi_{p0}/\rho_s^3\mu_0$.
The Solov'ev assumptions consist of \(A/R_0 = -I \frac{d I}{d  \psi_p }\) and \((1-A)/R_0^3 = -\frac{d p}{d  \psi_p }\), where \(A\) is a constant~\cite{Cerfon2010,Cerfon2014}.
By integration over \(\psi_p\) we find
\begin{align}\label{eq:solovevassumption}
 p(\psi_p) &= (A-1)\psi_p/R_0^3,  &
 I(\psi_p) &= \sqrt{-2 A \psi_p/R_0 + 1}, &
 j_\varphi &= \left[(A-1)R - A R_0^2 / R\right]/R_0^3.
\end{align}
Now, we introduce \(\bar{R} \equiv \frac{R}{R_0}\) and \(\bar{Z} \equiv\frac{Z}{R_0}\)
and solve Equations~\eqref{eq:GSEdimless} and~\eqref{eq:solovevassumption} to obtain
\begin{align}
 \psi_p (R,Z) &= R_0 \left[ \frac{1}{8}\bar{R}^4 + A\left( \frac{1}{2} \bar{R}^2 \ln{\bar{R}} 
   - \frac{1}{8}\bar{R}^4\right) + \sum_{i=1}^{12} c_{i}  \bar{\psi}_{pi}\right],
\end{align}
with
\rowcolors{2}{gray!25}{white}
\begin{longtable}{>{\RaggedRight}p{7cm}>{\RaggedRight}p{7cm}}
\toprule
  $\bar{\psi}_{p1}=1$
  & $\bar{\psi}_{p7}=8\bar{Z}^6 -140 \bar{R}^2 \bar{Z}^4
                      + 75 \bar{R}^4 \bar{Z}^2 - 15\bar{R}^6\ln{\bar{R}}+ 180 \bar{R}^4 \bar{Z}^2 \ln{\bar{R}} \
                       -120 \bar{R}^2 \bar{Z}^4 \ln{\bar{R}}$\\
%
  $\bar{\psi}_{p2}=\bar{R}^2$ &
  $\bar{\psi}_{p8}=\bar{Z}$ \\
%
  $\bar{\psi}_{p3}=\bar{Z}^2 - \bar{R}^2 \ln{\bar{R}}$ &
  $\bar{\psi}_{p9}=\bar{Z}  \bar{R}^2$\\
%
  $\bar{\psi}_{p4}=\bar{R}^4 -4\bar{R}^2\bar{Z}^2$ &
  $\bar{\psi}_{p10}=\bar{Z}^3 - 3 \bar{Z} \bar{R}^2 \ln{\bar{R}}$\\
  %
  $\bar{\psi}_{p5}=2\bar{Z}^4 - 9 \bar{R}^2\bar{Z}^2 + \
                     3 \bar{R}^4 \ln{\bar{R}} \
                    -12  \bar{R}^2\bar{Z}^2 \ln{\bar{R}}$
  &
$\bar{\psi}_{p11}=3 \bar{Z}\bar{R}^4 - 4\bar{Z}^3\bar{R}^2$\\
%
  $\bar{\psi}_{p6}=\bar{R}^6 -12 \bar{R}^4 \bar{Z}^2
                     + 8  \bar{R}^2 \bar{Z}^4$ &
  $\bar{\psi}_{p12}= 8 \bar{Z}^5 -45 \bar{Z} \bar{R}^4 - \
                       80 \bar{Z}^3 \bar{R}^2\ln{\bar{R}} \
                       +60 \bar{Z} \bar{R}^4\ln{\bar{R}}$ \\
   & \\
\bottomrule
\end{longtable}
The choice of the coefficients \(c_{i}\) and \(A\) determines the actual form of the magnetic field. It allows axisymmetric equilibria with e.g. single and asymmetric double X-point configurations, force-free states,
field reversed configurations and low and high beta tokamak equilbria. This casts this simple analytical equilibrium to the ideal choice in order to study geometric effects (e.g. inverse aspect ratio, elongation and triangularity) in magnetised plasmas.

Note that
\begin{align}
    B^R&=B_R = R_0\psi_Z/R \\
    B^Z&=B_Z = - R_0\psi_R/R \\
    B^\varphi &= B_\varphi/R^2 = R_0I/R^2
\end{align}
(contra- and covariant components of $\vec B$).
By construction we have $\partial_\varphi B = 0$ with
\begin{align}
  B = \frac{R_0}{R}\sqrt{ {I^2 + |\nabla \psi_p|^2}}.
    \label{}
\end{align}
Furthermore, we have
\begin{align}
  \nabla_\parallel f(R,Z) = \frac{R_0}{RB}[f,\psi_p]_{RZ}\Rightarrow \nabla_\parallel \ln B = \frac{R_0}{RB^2}\left[B, \psi_p\right]_{RZ} = -\vec\nabla\cdot\bhat,\\
    \vec\nabla\times \vec B = \frac{R_0}{R}\left[ I_Z \ehat_R - I_R\ehat_Z + Rj_\varphi\ehat_\varphi  \right].
    \label{}
\end{align}
The latter together with Eq.~\eqref{eq:curl_curvature}
can be used as a consistency test for the correct implementation of the
curvature operators (remember to convert $Rj_\varphi \rightarrow j_\varphi$ to get the contravariant component).
We allow various simplifications to the curvature operator
for the Solov'ev equilibrium.

%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Toroidal field line approximation}\label{sec:torfieldlineapprox}
The toroidal field line approximation applies \(\bhat\approx \ehat_\varphi\) to all perpendicular operators
(e.g.: Poisson bracket, perpendicular elliptic operator and curvature operators)
but retains the full expression for the magnetic field unit vector \(\bhat\)
for parallel operators (\(\nabla_\parallel\) and \(\Delta_\parallel\)).
In cylindrical coordinates that is
\begin{align}
[f,g]_\perp \equiv [f,g]_{RZ} &= \frac{1}{R} \left(\partial_R f\partial_Z g - \partial_Z f\partial_R g\right) \\
\nabla_\perp f &= \partial_R f \ehat_R + \partial_Z f \ehat_Z \\
\Delta_\perp f &= \frac{1}{R}\partial_R \left( R \partial_R f\right) + \partial_Z(\partial_Z f)
\label{}
\end{align}
The curl of $\bhat$ reduces to
%\begin{align}
 $\nabla\times\bhat \approx -  \frac{1}{R} \ehat_Z$.
%end{align}
This simplifies the curvature operators to:
\begin{align}
\vec{\mathcal{K}}_{\kappa}  &\approx  -  \frac{1}{B R} \ehat_Z , &
\vec{ \mathcal{K} }_{\vec{\nabla}  B}  &\approx  -\frac{1}{B^2}\frac{\partial B}{\partial Z}\ehat_R +\frac{1}{B^2} \frac{\partial B}{\partial R}\ehat_Z &
%\ehat_\varphi \times \vec{\nabla} B, &
\vec{ \mathcal{K} } &\approx \vec{ \mathcal{K} }_{\vec{\nabla}  B}  +\vec{ \mathcal{K} }_{\kappa} ,
%\\
%\mathcal{K}_{\kappa}(f)   &\approx  -  \frac{1}{B R} \frac{\partial f}{\partial Z},&
%\mathcal{K}_{\vec{\nabla}  B} (f)  &= \frac{1}{B} \left[\ln B, f \right]_{RZ},&
%\mathcal{K} (f) &\approx\frac{1}{B} \left[\ln B, f \right]_{RZ}-  \frac{1}{B R} \frac{\partial f}{\partial Z} ,
\end{align}
and
\begin{align}
 \vec{\nabla} \cdot \vec{\mathcal{K}}_{\kappa} &\approx \frac{1}{R B^2} \frac{\partial B}{\partial Z}.
\end{align}
which, results in a vanishing divergence of the curvature operators \( \vec{\nabla} \cdot \vec{ \mathcal{K} } = 0\).

Note that in an actual toroidal field we have
\begin{align}
  \vec B(R) := \frac{R_0}{R} \ehat_\varphi
  \label{}
\end{align}
We then have $\bhat = \ehat_\varphi$ and the curvature operators further
simplify to
\begin{align}
  \vec{ \mathcal K_\kappa} = \vec{ \mathcal K_{\nabla B}} = -\frac{1}{R_0} \ehat_Z =
\vec{ \mathcal K}/2\\
  \nabla\cdot\vec{\mathcal K_{\kappa}}=
    \nabla_\parallel \ln B = 0
    \label{}
\end{align}

\subsubsection{Low beta approximation}\label{sec:lowbetaapprox}
In this approximation we apply the toroidal field line approximation
as in Section
\ref{sec:torfieldlineapprox}
but approximate the curvature operator $\mathcal K_\kappa \approx \bhat\times\kappa$.
  with
  $\vec \kappa := \bhat \cdot \vec \nabla\bhat = -\bhat \times(\vec \nabla\times \bhat)$.
For an isotropic pressure plasma \(\vec{P} = \vec{I} P_\perp + \vec{b} \vec{b} P_\Delta \approx \vec{I} P_\perp\) and with the definition of the plasma beta parameter
\(\beta = \frac{P}{B^2/(2 \mu_0) } \)
we can rewrite the curvature to
\begin{align}
 \vec{\kappa} &\approx \frac{\beta}{2} \vec{\nabla} \ln(P) +\vec{\nabla}_\perp \ln{B} .
\end{align}
In low beta plasmas \(\beta\ll1\) the curvature reduces to:
\begin{align}
 \vec{\kappa} & \approx \vec{\nabla}_\perp \ln{B} .
\end{align}
This simplifies the curvature operators to:
\begin{align}
\mathcal{K}_{\kappa}(f)   &\approx  \mathcal{K}_{\vec{\nabla}  B}(f),  &
\mathcal{K} (f) &\approx 2\mathcal{K}_{\vec{\nabla}  B} (f) , &
 \vec{\kappa} \cdot \vec{\mathcal{K}}_{\vec{\nabla}  B} &= 0.
\end{align}
The divergence over the curvature vanishes \( \vec{\nabla} \cdot \vec{ \mathcal{K} } = 0\) only if \( \vec{\nabla} \cdot \vec{ \mathcal{K}}_{\vec{\nabla}  B}   = 0\).
In general, the divergence \( \vec{\nabla} \cdot \vec{ \mathcal{K} } \approx 0\) is only approximately vanishing.
\subsubsection{True perpendicular terms}
Without any approximations we have
\begin{align}
b^R = {\frac{\partial \psi}{\partial Z}}\left(I^2+|\nabla\psi|^2\right)^{-1/2} \quad
b^Z = -{\frac{\partial \psi}{\partial R}}\left(I^2+|\nabla\psi|^2\right)^{-1/2} \quad 
b^\varphi = \frac{I}{R}\left(I^2+|\nabla\psi|^2\right)^{-1/2} \\
\vec\nabla\cdot\bhat = -\nabla_\parallel \ln B = -\frac{R_0}{R B^2}[B,\psi_p]_{RZ}
\label{}
\end{align}
We then need to take the exact definitions for $[.,.]_\perp$, $\nabla_\perp$ and $\Delta_\perp$ from Section~\ref{sec:magnetic}.
We can explicitly write
\begin{align}
K_{\nabla B}^R &= -\frac{R_0 I}{B^3R}\frac{\partial B}{\partial Z} \equiv -\frac{1}{B^2}\frac{\partial B}{\partial Z}b^\varphi \\
K_{\nabla B}^Z &= \frac{R_0 I}{B^3R}\frac{\partial B}{\partial R}\equiv \frac{1}{B^2}\frac{\partial B}{\partial R}b^\varphi \\
K_{\nabla B}^\varphi &= \frac{R_0}{B^3R^2}\left(
      \frac{\partial \psi}{\partial Z} \frac{\partial B}{\partial Z}
    + \frac{\partial \psi}{\partial R}\frac{\partial B}{\partial R}\right)
%\equiv \frac{1}{B^2R}\left(\bhat^R \frac{\partial B}{\partial Z} - \bhat^Z \frac{\partial B}{\partial R}\right)\quad %contravariant phi component
\label{}
\end{align}
and
\begin{align}
K_\kappa^R &= \frac{R_0 }{RB^3}\left( B\frac{\partial I}{\partial Z} -I\frac{\partial B}{\partial Z}\right) \\
K_\kappa^Z &= \frac{R_0 }{RB^3} \left( I\frac{\partial B}{\partial R} - B\frac{\partial I}{\partial R} \right)\\
K_\kappa^\varphi &= \frac{R_0}{R^2B^2}\left(
+ \frac{1}{B}\frac{\partial\psi}{\partial Z} \frac{\partial B}{\partial Z}
+ \frac{1}{B}\frac{\partial \psi}{\partial R}\frac{\partial B}{\partial R}
-R\frac{\partial}{\partial R}\left(\frac{1}{R}\frac{\partial\psi}{\partial R}\right) 
- \frac{\partial^2 \psi}{\partial Z^2}
\right) \\
\vec\nabla\cdot\vec{\mathcal K_\kappa} &= -\vec\nabla\cdot\vec{\mathcal K_{\nabla B}}=
    -\vec{\mathcal K_\kappa}\cdot \vec \nabla\ln B = \frac{R_0}{RB^3}[I,B]_{RZ}
%contravariant phi component
\label{}
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The model}
\subsection{Dimensional Equations}
% \(n_e\) is the electron density, \(N_i\) is the ion gyro-centre density, \(\phi\) is the electric potential,
% \\
% This model is an isothermal 3D gyro-fluid model, which exploits the toroidal field line approximation in the curvature operator terms (cf.~\ref{sec:torfieldlineapprox}).
% It incorporates a Solov'ev equilibrium (cf.~\ref{sec:solovev}) for the magnetic field, which allows a
% realistically shaped axisymmetric magnetic field. The coordinate system of choice is a non-aligned  cylindrical coordinate system (cf.~\ref{sec:cylmetric} and~\ref{sec:nonparallelalignedmetric}), which allows
% the correct numerical treatment of singular points (e.g. X- and O- Points). These points occur naturally in realistic magnetic field configurations.
% Since it is based on a global geometry, treating the complete poloidal flux surface, it is suited for coupled simulations of core, edge and SOL.
% However, our isothermal model misses important core physics ingredients, such as the ion temperature gradient (ITG) and trapped electron mode (TEM)~\cite{Wesson07}. Thus the validity the global model is limited to certain
% parameter regimes.\\
The continuity equations for the electron density \(n_e\) and  ion gyro-centre density electrons  \(N_i\) read
\begin{align}
 \frac{\partial}{\partial t}n_e =&
 - \frac{1}{B}\left[\phi,  n_e \right]_{\perp}
 -  \bar{\nabla}_{\parallel}( n_e u_e)
 + n_e u_e   \bar{\nabla}_{\parallel} \ln{(B)}
+ \frac{t_e }{e }  \mathcal{K} \left( n_e\right)
\nonumber  \\ &
-   n_e \mathcal{K}(\phi)
%  + \frac{m_e }{ e } n_e u_e \mathcal{K} \left(  u_e \right)
%  + \frac{m_e }{2 e } u_e^2 \mathcal{K} \left(n_e \right) +
   +  \frac{m_e }{ e } \mathcal{K}_{\kappa} \left( n_e u_e^2 \right)
   + \frac{m_e }{ e } \left( n_e u_e^2 \right) \vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
   + \Lambda_{n_e} + S_{n_e},\\
\frac{\partial}{\partial t}N_i =&
 - \frac{1}{B}\left[\psi_i,  N_i \right]_{\perp}
 - \bar{\nabla}_{\parallel}(N_i U_i)
 + N_i U_i   \bar {\nabla}_{\parallel} \ln{(B)}
- \frac{T_i }{e }  \mathcal{K} \left( N_i\right)
\nonumber  \\ &
-   N_i \mathcal{K}(\psi)
%  - \frac{m_i }{ e } N_i U_i \mathcal{K} \left(  U_i \right)
%  - \frac{m_i }{2 e } U_i^2 \mathcal{K} \left(N_i \right) +
- \frac{m_i }{ e }\mathcal{K}_{\kappa}  \left( N_i U_i^2 \right)
- \frac{m_i }{ e } \left( N_i U_i^2 \right)\vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
+ \Lambda_{N_i} + S_{N_i}.
\end{align}
The evolution equation for the parallel electron velocity \(u_e\) and the parallel ion gyro-centre velocity \(U_i\) are
\begin{align}
\frac{\partial}{\partial t}\left(  u_e -\frac{e}{m_e} A_\parallel\right)
      =&
      - \frac{1 }{ B} \left[ \phi, u_e  \right]_{\perp}
      +  \frac{e}{m_e}   \bar \nabla_\parallel \phi
      -   \frac{1}{2}   \bar \nabla_\parallel u_e^2
      - \frac{t_e}{m_e } \bar \nabla_\parallel \ln  n_e
     - u_e   \mathcal{K}_{\kappa} \left( \phi  \right)
     + \frac{t_e}{e} \mathcal{K}\left(  u_e \right)
     \nonumber  \\    &
%      + \frac{m_e  u_e^2}{ e} \mathcal{K}_{\kappa} \left(u_e\right)
%     + \frac{2  t_e}{ e} \mathcal{K}_{\kappa} \left(u_e\right)
     + \frac{1}{e} \left(m_e  u_e^2 +  2  t_e\right)\mathcal{K}_{\kappa} \left(u_e\right)
    + \frac{2  t_e u_e }{ e} \mathcal{K}_{\kappa} \left(\ln n_e \right)
    + \frac{t_e  u_e }{e} \vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
%      +\frac{  t_e u_e }{e }  \mathcal{K}\left( \ln n_e \right)
%       +\left(\frac{2  t_e  }{e} + \frac{m_e  u_e^2}{2 e} \right) \mathcal{K} \left(u_e\right)
%       +\frac{e}{m_e}   \eta_{\parallel} J_\parallel
    + R_{e, \eta_\parallel}+\Lambda_{u_e} ,  \\
\frac{\partial}{\partial t}   \left( U_i + \frac{e}{m_i} A_\parallel\right)
      =&
      - \frac{1 }{ B} \left[ \psi_i, U_i  \right]_{\perp}
      -  \frac{e}{m_i}   \bar \nabla_\parallel \psi_i
      -     \frac{1}{2}  \bar \nabla_\parallel U_i^2
      - \frac{T_i}{m_i } \bar \nabla_\parallel \ln  N_i
     -  U_i  \mathcal{K}_{\kappa} \left( \psi_i  \right)
     - \frac{T_i}{e} \mathcal{K}\left(  U_i \right)
     \nonumber  \\    &
%            - \frac{m_i  U_i^2}{ e} \mathcal{K}_{\kappa} \left(U_i\right)
%            - \frac{2  T_i}{ e} \mathcal{K}_{\kappa} \left(U_i\right)
           - \frac{1}{e}\left(m_i  U_i^2 + 2  T_i \right) \mathcal{K}_{\kappa} \left(U_i\right)
           - \frac{2  T_i U_i }{ e} \mathcal{K}_{\kappa} \left(\ln N_i \right)
           - \frac{T_i  U_i }{e} \vec{\nabla} \cdot  \vec{\mathcal{K}}_{\kappa}
%      -\frac{  T_i U_i }{e }  \mathcal{K}\left( \ln N_i \right)
%       -\left(\frac{2  T_i  }{e} + \frac{m_i  U_i^2}{2 e} \right) \mathcal{K} \left(U_i\right)
%       -\frac{e}{m_i}   \eta_{\parallel} J_\parallel
         + R_{i,\eta_\parallel}  +\Lambda_{U_i}  .
\end{align}
The electric potential \(\phi\) and parallel magnetic vector potential are
computed by the polarisation and induction equations
\begin{align}
  n_e -\Gamma_{1,i} N_i &= \vec{\nabla} \cdot\left(\frac{N_i}{\Omega_i B} \vec{\nabla}_\perp \phi\right), \\
  -\frac{1}{\mu_0} \Delta_\perp A_\parallel &= -en_e u_e + eN_i U_i
  \label{eq:polarisation_dimensional}
\end{align}
with the generalised electric potential
\begin{align}
  \psi_i&:= \Gamma_{1,i} \phi - \frac{m_i }{2 q}\frac{(\nabla_\perp\phi)^2}{B^2}, \quad \Gamma_{1,i}^{-1} := 1-\frac{m_i T_i}{2q^2 B_0^2} \Delta_\perp
\end{align}

\subsection{Conservative form}
Note that the continuity and momentum conservation equations can be
written in the form
\begin{align}
\frac{\partial}{\partial t} N &+ \vec\nabla\cdot\left( N \left(
    \vec v_E + \vec v_C + \vec v_{\nabla B} + U\bhat + U\tilde{\vec b}\right)\right) = \Lambda_N + S_N \\
mN \frac{\partial}{\partial t} U &+ mN \left(
    \vec v_E + \vec v_C + \vec v_{\nabla B} + U\bhat + U\tilde{\vec b}
    \right)\cdot \vec\nabla U  \nonumber \\
    &+ \vec \nabla \cdot ( 2mNU \vec v_\kappa)
    + mNU\mathcal K_\kappa(\phi)
    + mNU\vec v_\kappa \cdot \nabla \ln B \nonumber\\
    &= -T \bar \nabla_\parallel N -qN ( \bar \nabla_\parallel \psi + \partial_t A_\parallel) + mN R_\eta + mN\Lambda_U
\label{}
\end{align}
with the velocities
\begin{align}
\vec v_E := \frac{\bhat\times\nabla\phi}{B},\quad
\vec v_C := \frac{T+mU^2}{q}\vec{\mathcal K_\kappa},\quad
\vec v_\kappa := \frac{T}{q}\vec{\mathcal K_\kappa},\quad
\vec v_{\nabla B} := \frac{T}{q}\vec{\mathcal K_{\nabla B}}.
\label{}
\end{align}
\subsection{Parallel Resistivity and diffusion}\label{sec:dissres}
The terms $R_{e/i,\eta_\parallel}$ account for resistive friction.
The parallel Spitzer resistivity
\begin{align}
\eta_\parallel := \frac{0.51 m_e \nu_{ei}}{n_e e^2}
\end{align}
and the approximate Spitzer current \(J_{\parallel,s}:= e n_e \left(U_i - u_e\right)\) determine the parallel resistive terms to:
\begin{align}
  R_{e,\eta_\parallel} &=  en_e\eta_\parallel J_{\parallel,s}/(m_en_e)  &
  R_{i,\eta_\parallel} &=- en_e\eta_\parallel J_{\parallel,s}/(m_iN_i)
\end{align}
The dissipative terms can be decomposed into perpendicular and parallel components
\begin{align}
 \Lambda_{n_e} &= \Lambda_{n_e,\perp}+\Lambda_{n_e,\parallel}, &
 \Lambda_{N_i} &= \Lambda_{N_i,\perp}+\Lambda_{N_i,\parallel},\\
 \Lambda_{u_e} &= \Lambda_{u_e,\perp}+\Lambda_{u_e,\parallel},&
 \Lambda_{U_i} &= \Lambda_{U_i,\perp}+\Lambda_{U_i,\parallel}.
\end{align}
For numerical stabilisation we choose:
\begin{align}
\Lambda_{n_e,\parallel} &= \nu_\parallel \Delta_\parallel n_e &
\Lambda_{N_i,\parallel} &= \nu_\parallel \Delta_\parallel N_i \\
\Lambda_{u_e,\parallel} &= \nu_\parallel \Delta_\parallel u_e &
\Lambda_{U_i,\parallel} &= \nu_\parallel \Delta_\parallel U_i 
\end{align}
Similarly, for the perpendicular dissipation we apply hyperviscous terms of second order.
\begin{align}\label{eq:perpdiffNT}
 \Lambda_{n_e,\perp} &=  -\nu_\perp \Delta_\perp^2 n_e &
 \Lambda_{N_i,\perp} &=  -\nu_\perp \Delta_\perp^2 N_i  & \\
 \Lambda_{u_e,\perp} &=  -\nu_\perp \Delta_\perp^2 (u_e - eA_\parallel/m_e)  &
 \Lambda_{U_i,\perp} &=  -\nu_\perp \Delta_\perp^2 (U_i + eA_\parallel/m_i)
\end{align}
Here the mass diffusion coefficient coincides with the viscous coefficient, hence we fixed the Schmidt number \(\mathit{Sc}_\parallel:= \frac{\nu_U}{\nu_N}\) to unity.

\subsection{Boundary and Initial conditions}
We define the simulation box as
$[ R_{\min}, R_{\max}]\times [Z_{\min}, Z_{\max}] \times [0,2\pi]$,
where we define
\begin{align} \label{eq:box}
    R_{\min}&=R_0-\varepsilon^{R-}a\quad
    &&R_{\max}=R_0+\varepsilon^{R+}a\nonumber\\
    Z_{\min}&=-\varepsilon^{Z-}ae\quad
    &&Z_{\max}=\varepsilon^{Z+}ae
\end{align}
where $a$ is the minor radius, $e$ is the elongation of the flux surfaces and
the $\varepsilon$ are free parameters to be specified by the user.

We choose boundary conditions seperately on input for the variables
$n_e$, $u_e$ and $\phi$. The boundary condition for $N_i$, $U_i$ and
$\psi$ are equal to $n_e$, $u_e$ and $\phi$ respecitively.
Typically,
\begin{align}
n_e = n_0, \quad u_e = \phi = 0
\text{ or } \hat n \cdot \nabla n_e = \hat n \cdot \nabla u_e = 0
\end{align}
where $\hat n$ is the normal vector to the boundary.

We initialize the parallel velocitiy to zero
\begin{align}
  u_e(R,Z,\varphi,0) = U_i(R,Z,\varphi,0) = 0
  \label{}
\end{align}
which in turn initializes $A_\parallel = 0$
and initialize the electron density with
\begin{align} \label{eq:initial_ne}
    n_e(R,Z,\varphi, 0)= n_{prof}(R,Z) + \tilde n(R,Z,\varphi)
\end{align}
consisting of a toroidally symmetric background profile $n_{\text{prof}}(R,Z)$ and a perturbation
$\tilde n(R,Z,\varphi)$.
Let us define an approximate Heaviside function
\begin{align}
  \Theta(x) := \frac{1}{2}\left( 1 + \tanh\left( \frac{x-3\alpha}{ \alpha} \right) \right) \quad \Theta(x) \approx H(x)
  \label{eq:heaviside_profile}
\end{align}
where $H(x)$ is the actual Heaviside function and
$\alpha$ is a (small) width parameter.
We can then define a flux-aligned density profile as
\begin{align} \label{eq:density_profile}
  n_{\text{prof}}(R,Z)=
      n_0 + \triangle n_{peak}\frac{\psi_p(R,Z)}{\psi_p(R_0, 0)} \Theta( -\psi_p(R,Z)) H(Z-Z_X)
\end{align}
The second Heaviside is multiplied only if the equilibrium $\psi_p$ has an
X-point and avoids a profile in the private flux region.

We have two possibilities to initialize the ion density
\begin{align} \label{eq:initphi}
  N_i = \Gamma_{1,i}^{-1} n_e \text{ or } N_i = n_e
\end{align}
In the first case the potential $\phi= 0$ while in the second case
the $E\times B$ and ion diamagnetic vorticity coincide $\Delta N_i \propto \Delta \phi$.
We can choose between several initial conditions for $\tilde n$:

\subsubsection{Blob and Straight blob}
We initialize a blob in the R-Z plane
\begin{align} \label{eq:initial_blob}
  \tilde n_{blob}(R,Z,0) = \triangle n \exp\left( -\frac{(R - R_0 - p_x a)^2 + (Z-p_ya)^2}{\sigma^2} \right)
\end{align}
Then, we use fieldline integration modulated by 
\begin{align}
  m_{blob}(s) = \exp\left( -\frac{s^2 }{\pi^2\sigma_z^2} \right)
\end{align}
to transform this blob to all other poloidal
planes.
We either follow fieldlines around the torus several times (``blob'') or only once
(``straight blob'').
\subsubsection{Turbulent bath}
We can initialize the R-Z plane with a turbulent bath with a certain amplitude $A$.
Again, we transform this to all poloidal planes along the magnetic field lines and multiply the bath with
\begin{align} \label{eq:initial_turbulent}
\tilde n_e(R,Z,\varphi) = \tilde n_{\text{bath}}(R,Z,\varphi)\Theta(-\psi_p)H(Z-Z_X)
\end{align}
\subsubsection{Zonal flows}
We can initialize the R-Z plane with zonal flows of amplitude $A$ and
wavelength $k_\psi$ aligned with the magnetic flux surfaces.
\begin{align} \label{eq:initial_zonal_flow}
    \tilde n_{\text{zonal}}(R,Z) &= A \sin (2\pi k_\psi \psi_p(R,Z)) \nonumber\\
\tilde n_e(R,Z,\varphi) &= \tilde n_{\text{zonal}}(R,Z)\Theta(-\psi_p)H(Z-Z_X)
\end{align}

\subsection{Particle sources} \label{sec:sources}
The idea for the source terms $S$ is to fix the profile $n_{prof}$ in the
core of our domain, where our model does not apply.
We thus define a particle source for electrons as
\begin{align} \label{eq:electron_source}
  S_{n_e}(R,Z,\varphi, t) &= \omega_s
    (n_{prof}(R,Z) - n_e(R,Z,\varphi, t))\Theta( \rho_{\max} -\rho(R,Z)) H(Z-Z_X) \\
    \rho(R,Z) &:= \frac{\psi_p(R_0,0)- \psi_p(R,Z) }{\psi_p(R_0,0)},
\end{align}
with $0 < \rho_{\max}<1$
where $\omega_s$ is the source strength parameter. This will result in exponential adaption of the core
density profile of the form $n_e \propto n_{prof}+(n_{prof}-n_{e,0})e^{-\omega_st}$.
For ions we use
\begin{align}
    S_{N_i} = \Gamma_{1,i}^{-1} S_{n_e} = \left(1-\frac{m_i T_i}{2q^2 B_0^2} \nabla_\perp^2\right) S_{n_e}
  \label{eq:ion_source}
\end{align}
Note that Eq.~\eqref{eq:ion_source} is explicitly chosen as to avoid vorticity generation
by the particle source (cf.~Section~\ref{sec:conservation}). $S_{n_e}$ needs to be smooth
so that $\nabla_\perp^2 S_{n_e}$ is well defined.


\subsection{Conservation laws} \label{sec:conservation}
\subsubsection{Mass conservation}
Integrating the density equation we directly get
\begin{align} \label{eq:mass_conservation}
  \frac{\partial}{\partial t} \int d\vec{x} n_e =  - \int d\vec{x} (\Lambda_{n_e}+S_{n_e})
\end{align}
\subsubsection{Charge/vorticity conservation}
Integrating the polarisation equation~\eqref{eq:polarisation_dimensional}
and assuming $\Gamma_{1,i}S_{N_i} = S_{n_e}$ we find
\begin{align} \label{eq:charge_conservation}
  \frac{\partial}{\partial t} \int d\vec{x} \vec{\nabla} \cdot\left(\frac{N_i}{\Omega_i B} \vec{\nabla}_\perp \phi\right) =  - \int d\vec{x} (\Lambda_{n_e} - \Gamma_{1,i}\Lambda_{N_i})
\end{align}
Note that if the integrand on the left hand side is interpreted as the \ExB vorticity
density
$\zeta := \nabla\cdot( N_i\nabla_\perp/\Omega_i B)$
and if we further assume that $\Gamma_{1,i} \Lambda_{N_i} \equiv \Lambda_{\Gamma_{1,i}N_i}$, and insert the ion source term~\eqref{eq:ion_source}
we get the vorticity conservation
\begin{align} \label{eq:vorticity_conservation}
  \frac{\partial}{\partial t} \int d\vec{x} \zeta =  - \int d\vec{x}\Lambda_{\zeta}
\end{align}

\subsubsection{Energy theorem}
The terms of the energy theorem $\partial_t \mathcal E + \mathcal S =
\Lambda$ are derived to (if either $\psi$ or $\nabla\psi$ vanishes at the
boundary)
\begin{align} \label{eq:energy_conservation}
  \mathcal{E} = \int  \dV & \left( t_e n_e \ln{(n_e)} +T_i N_i\ln{(N_i)}+
  \frac{(\nabla_\perp A_\parallel)^2}{2\mu_0} +  \frac{1}{2} m_i N_i u_E^2
  +\frac{1}{2} m_e  n_e u_e^2 +\frac{1}{2} m_i  N_i U_i^2  \right),\\
  \mathcal S = \sum_s \int \vec{\dA} \cdot &\left[ \left(
  U(\bhat+\tilde{\vec b}) + \vec v_E + \vec v_C + \vec v_{\nabla B} \right)
  \left(T N\ln N + \frac{1}{2}m NU^2 + q\psi N \right) \right. \nonumber\\
  & \left . + \vec v_\kappa m NU^2  + (\bhat + \tilde{\vec b}) UNT\right], \\
  \Lambda =  \int \dV & \bigg\{  \left[t_e\left( 1+\ln{(n_e)}\right) -e \phi + \frac{1}{2} m_e u_e^2 \right](\Lambda_{n_e} + S_{n_e})
  \nonumber\\ &
+\left[T_i\left( 1+\ln{(N_i)}\right) +e \psi_i + \frac{1}{2} m_i U_i^2 \right](\Lambda_{N_i}+S_{N_i})
\nonumber \\ &
+ m_e u_e n_e \Lambda_{u_e}+m_iU_i N_i \Lambda_{U_i} - \eta_\parallel J_{\parallel,s}^2\bigg\}.
\end{align}
The energy consists of the Helmholtz free energy density for electrons and ions, the \(\vec{E} \times \vec{B}\) energy density, the parallel energy densities for electrons and ions and the perturbed magnetic field energy density.
In \(\Lambda\) we insert the dissipative terms of Section~\ref{sec:dissres}. \\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Dimensionless form}
We scale all spatial lengths by $\rho_s = \sqrt{T_e m_i}/(eB_0)$ and time by the ion gyrofrequency $\Omega_0 = eB_0/m_i$.
The magnetic field is scaled with $B_0$, densities with $n_0$ and the parallel velocity is scaled with $c_s = \sqrt{T_e/m_i}$.
The potential is scaled with $\hat \phi = e/T_e$ and the vector potential with 
$\hat A_\parallel = \beta \rho_s B_0$ (this particular choice for $\hat
A_\parallel$ allows to easily recover the electrostatic limit $\beta = 0$ but
note that $\beta$ now appears in the definition of $\bar \nabla_\parallel$).
We introduce the dimensionless parameters
\begin{align}
  \tau_a = \frac{T_a}{z_aT_e}~,\quad \mu_a = \frac{m_a}{z_am_i}\text{ and } 
  \beta:=\frac{\mu_0 n_0 T_e}{B_0^2}
  \label{}
\end{align}
where $a\in\{e,i\}$ is the species label and $z$ is the charge number. Finally, we define
\begin{align}
  \eta:=\frac{en_0\eta_\parallel}{B_0} = 8.45\cdot 10^{-5}\ln \lambda \left(\frac{n_0}{10^{19}\text{m}^3}\right) \left(\frac{T_e}{\text{eV}}\right)^{-3/2} \left(\frac{B_0}{\text{T}}\right)^{-1}.
    \label{eq:resistivity}
\end{align}
Omitting the species label we arrive at (dividing the density equation by $\Omega_0n_0$ and the velocity equation by $\Omega_0 c_s$)
\begin{subequations}
    \begin{align}
    \frac{\partial}{\partial t} N =&
        - \frac{1}{B}[\psi, N]_{\perp}%\nonumber\\
        - \bar \nabla_\parallel \left( NU\right)
        + NU\bar \nabla_\parallel\ln(B)
        - \tau \mathcal K(N) \nonumber \\&
        - N \mathcal K(\psi)
        -\mu \mathcal K_\kappa(NU^2)
        -\mu NU^2\nabla\cdot \vec{ \mathcal K_\kappa}
        - \nu_\perp\Delta_\perp^2 N + \nu_\parallel \Delta_\parallel N + S_N, \\
    \frac{\partial}{\partial t} W =&
        - \frac{1}{B}\left[\psi, U\right]_{\perp}%& \nonumber\\
        - \frac{1}{\mu} \bar \nabla_\parallel \psi% \nonumber\\
        - \frac{1}{2}\bar \nabla_\parallel U^2
        -\frac{\tau}{\mu} \bar \nabla_\parallel \ln N
        - U\mathcal K_\kappa(\psi)
        - \tau \mathcal K(U)
        -\tau U\nabla\cdot\vec{ \mathcal K_\kappa}\nonumber\\&
        - \left(2\tau + {\mu}U^2\right) \mathcal K_\kappa (U)
        -2\tau U\mathcal K_\kappa(\ln N)
        - \frac{\eta}{\mu} \frac{n_e}{N}n_e(U_i - u_e)
        - \nu_\perp\Delta_\perp^2 W + \nu_\parallel \Delta_\parallel U ,
        \label{eq:EgyrofluidU} \\
        W&:= \left( U + \frac{\beta}{\mu}A_\parallel\right)
    \end{align}
    \label{eq:Egyrofluid}
\end{subequations}
together with
  \begin{align}
    -\nabla\cdot\left( \frac{N_i}{B^2}\nabla_\perp \phi \right) &= \Gamma_{1,i} N_i - n_e, \quad\quad
    \Gamma_{1,i}^{-1} = 1-\frac{1}{2}\tau_i\mu_i \Delta_\perp \\
    \psi &= \Gamma_{1,i}\phi -\frac{1}{2}\frac{(\nabla_\perp\phi)^2}{B^2} \\
    \left(\frac{\beta}{\mu_i}n_e - \frac{\beta}{\mu_e}N_i-\Delta_\perp\right)
    A_\parallel &= -n_e w_e + N_iW_i
  \end{align}
The energy theorem reads $\partial_t \mathcal E + \mathcal S = \Lambda$
\begin{align}
  \mathcal{E}= \int  \dV & \left( z_e\tau_e n_e \ln{(n_e)} +z_i\tau_i N_i\ln{(N_i)}
  +\frac{\beta}{2}\left(\nabla_\perp A_\parallel\right)^2
   +  \frac{1}{2} \mu_i N_i u_E^2  \right .\nonumber\\
   &\left. +\frac{1}{2} z_e\mu_e  n_e u_e^2
  +\frac{1}{2} z_i\mu_i  N_i U_i^2  \right),\\
  %\mathcal S = \sum_s \int \vec{\dA} & \cdot\left[ \left( U\bhat + \vec v_\perp )
  %(z\tau N\ln N + \frac{1}{2}z\mu NU^2 + \psi N \right) + \vec v_C' z\mu NU^2 + \bhat UNT \right], \\
  \Lambda =  \int \dV & \bigg\{  z_e\left[\tau_e\left( 1+\ln{(n_e)}\right) + \phi + \frac{1}{2} \mu_e u_e^2 \right](\Lambda_{n_e} + S_{n_e})
  \nonumber\\ &
+z_i\left[\tau_i\left( 1+\ln{(N_i)}\right) + \psi_i + \frac{1}{2} \mu_i U_i^2 \right](\Lambda_{N_i}+S_{N_i})
\nonumber \\ &
+ z_e\mu_e u_e n_e \Lambda_{u_e}+z_i\mu_iU_i N_i \Lambda_{U_i} - \eta J_{\parallel,s}^2\bigg\}.
\end{align}

\section{Numerical methods}
discontinuous Galerkin on structured grid
\rowcolors{2}{gray!25}{white} %%% Use this line in front of longtable
\begin{longtable}{p{4cm}l>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Term} &  \textbf{Method} & \textbf{Description}  \\ \midrule
    coordinate system & Cylindrical & equidistant discretization of $[R_{\min},R_{\max}] \times [Z_{\min},Z_{\max}] \times [0,2\pi]$ (Eq.~\eqref{eq:box}, equal number of Gaussian nodes in $R$ and $Z$, equidistant planes in $\varphi$ with one Gaussian node \\
Helmholtz and Elliptic matrix inversions & multigrid/ conjugate gradient & Use previous two solutions to extrapolate initial guess and $1/\chi$ as preconditioner \\
Parallel derivatives & refined  FCI & cf.~\cite{Held2016,Stegmeir2017} \\
Curvature terms & direct dG & regular dG approximation of derivatives \\
time & Adaptive ARKode stepper & $3rd$ order explicit, diffusion $3rd$ order implicit \\
\bottomrule
\end{longtable}
\section{Input/Output}
The programs \texttt{feltor\_hpc.cu} and \texttt{feltor\_mpi.cu}
expect two input files. One for the physical and numerical parameters
of the model equations and one that describes the Solov'ev equilibrium.
Both write results into an output file.

\subsection{Input file structure}
Input file format: json

%%This is a booktabs table
\begin{longtable}{llll>{\RaggedRight}p{6cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Example} & \textbf{Default} & \textbf{Description}  \\ \midrule
n      & integer & 3 & - &Number of Gaussian nodes in R and Z \\
Nx     & integer &52& - &Number of grid points in R \\
Ny     & integer &52& - &Number of grid points in Z \\
Nz     & integer &16& - &Number of grid points in $\varphi$ \\
dt     & integer &1e-2& - &initial time stepsize in units of $c_s/\rho_s$ \\
compression & integer[2] & [2,2] & [1,1] & Compress output file by reducing points in x and y: output contains n*Nx/c[0] points in x,
    (has to divde Nx evenly), and n*Ny/c[1] points in y,
    (has to divde Ny evenly)\\
itstp       & integer & 2  & - & Number of time steps between outputs \\
maxout      & integer & 10 & - & Total Number of outputs excluding first \\
eps\_time   & float & 1e-9  & - & Accuracy of solver for implicit part in time-stepper \\
rtol  & float &1e-6   & - &Tolerance of adaptive time-stepper \\
eps\_pol    & float & 1e-5  & - &  Accuracy of residual of the inversion of polarisation and induction Eq. \\
jumpfactor  & float & 1 & 1 & Jumpfactor $\in \left[0.01,1\right]$ in Elliptic\\
eps\_gamma  & float & 1e-6  & - & Accuracy of $\Gamma_1$  \\
stages      & integer & 3 & 3 & number of stages in multigrid, $2^{\text{stages-1}}$
has to evenly divide both $N_x$ and $N_y$\\
refineDS     & integer[2] & [10,10] & [10,10] & refinement factor in DS in R- and Z-direction\\
rk4eps     & float & 1e-5 & 1e-5 & Accuracy of fieldline integrator in DS\\
mu         & float & -0.00272121& - & $\mu_e =-m_e/m_i$.
    One of $\left\{ -0.000544617, -0.000272121, -0.000181372 \right\}$\\
tau        & float &1      & - & $\tau = T_i/T_e$  \\
beta       & float & 5e-6  & 0 & Plasma beta $5\cdot 10^{-6}$ (TJK), $4\cdot 10^{-3}$ (Compass), If $0$, then the model is electrostatic \\
nu\_perp   & float &1e-3   & - & pependicular viscosity $\nu_\perp$ \\
perp\_diff & string & "viscous" & "hyperviscous" & "hyperviscous": $\Lambda_\perp \propto -\nu_\perp\Delta_\perp^2$, "viscous": $\Lambda_\perp\propto \nu_\perp\Delta_\perp$ \\
nu\_parallel & float &1e-1 & - & parallel viscosity $\nu_\parallel$ \\
resistivity & float &1e-4  & - & parallel resistivity parameter Eq.~\eqref{eq:resistivity}\\
curvmode  & string & "low beta"  & "toroidal"& curvature mode ("low beta", "true" no approximation, "toroidal": toroidal field approx) \\
bc & dict & & & Dictionary of boundary conditions \ldots\\
\qquad density   & char[2] & [DIR,DIR] & -  & boundary conditions in x and y for $n_e$ and $N_i$\\
\qquad velocity  & char[2] & [DIR,DIR] & - & boundary conditions in x and y for $u_e$ and $U_i$\\
\qquad potential & char[2] & [DIR,DIR] & - & boundary conditions in x and y for $\phi$ and $\psi$\\
\qquad induction & char[2] & [DIR,DIR] & [DIR,DIR] & boundary conditions in x and y for $A_\parallel$ \\
    boxscaleR  & float[2] & [1.1,1.1]     & [1.05,1.05] & $[\varepsilon^{R-}, \varepsilon^{R+}]$ scale left and right boundary in units of $a$ Eq.~\eqref{eq:box}\\
    boxscaleZ  & float[2] & [1.2,1.1]     & [1.05,1.05] & $\varepsilon^{Z-}, \varepsilon^{Z+}$ scale lower and upper boundary in units of $ae$ Eq.~\eqref{eq:box} \\
initne    & string & "turbulence"     & "blob"  & initial condition for the
perturbation $\tilde n$ in \eqref{eq:initial_ne}. "zonal" (Eq.~\eqref{eq:initial_zonal_flow}),
    "blob" = blob simulations (several rounds fieldaligned),
    "straight blob" = straight blob simulation( 1 round fieldaligned),
    "turbulence" = turbulence simulations ( 1 round fieldaligned, Eq.~\eqref{eq:initial_turbulent})\\
initphi   & string & "zero"  & "balance" & initial condition for $\phi$ and thus $N_i$ (Eq.~\eqref{eq:initphi}: "zero" : $\phi = 0$, vanishing
electric potential, "balance": $n_e=N_i$, ExB vorticity equals ion diamagnetic vorticity (For $\tau_i =0 $ both are the same)
\\
amplitude  & float &0.01   & - & amplitude $A$ of initial perturbation (blob, turbulent bath or zonal flow)  \\
sigma      & float &2      & - & blob variance in units of $\rho_s$ \\
posX       & float &0.3    & - & blob R-position in units of $a$\\
posY       & float &0.0    & - & blob Z-position in units of $a$ \\
sigma\_z    & float &0.25   & - & variance in units of $R_0$  \\
k\_psi     & float &0    & - & zonal mode wave number  \\
nprofileamp& float &4   & - & Profile peak amplitude $N_{peak}$ in Eq.~\eqref{eq:density_profile} \\
source  & float & 0     & - & profile source rate $\omega_s$ in Eq.~\eqref{eq:electron_source} \\
alpha     & float  & 0.02 & - & Width $\alpha$ of Heaviside profile in Eq.~\eqref{eq:heaviside_profile} \\
rho\_source & float  & 0.2   & 0.2 & Source region boundary $0<\rho_{\max}<1$ in Eq.~\eqref{eq:electron_source}  \\
\bottomrule
\end{longtable}
The default value is taken if the value name is not found in the input file. If there is no default and
the value is not found,
the program exits with an error message.
\subsection{Geometry file structure}
File format: json

%%This is a booktabs table
\begin{longtable}{llll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Example} & \textbf{Default} & \textbf{Description}  \\ \midrule
    A      & float & 1 &  - & Solovev parameter \\
    C      & float[12] &  - & - & Solovev coefficients \\
    R\_0   & float & - & -  & Major radius $R_0$ in units of $\rho_s$ \\
    elongation    & float & 1 & - & Elongation $e$ \\
    triangularity & float & 0 & - & Triangularity $\delta$ \\
    inverseaspectratio & float & 0.16667 & - & minor to major radius $a/R_0$ \\
\bottomrule
\end{longtable}
The default value is taken if the value name is not found in the input file. If there is no default and
the value is not found,
the program exits with an error message.

\subsection{Output}
Output file format: netcdf-4/hdf5
%
%Name | Type | Dimensionality | Description
%---|---|---|---|
\begin{longtable}{lll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Dimension} & \textbf{Description}  \\ \midrule
inputfile  &     text attribute & 1 & verbose input file as a string \\
geomfile   &     text attribute & 1 & verbose geometry input file as a string \\
x                & Dataset & 1 & $R$-coordinate (computational space, compressed size: $nN_x/c_x$)\\
y                & Dataset & 1 & $Z$-coordinate (computational space, compressed size: $nN_y/c_y$)\\
z                & Dataset & 1 & $\varphi$-coordinate (computational space, size: $N_z$) \\
x\_XYZ           & Dataset & 3 (z,y,x) & Cartesian x-coordinate $x=R\sin(\varphi)$ \\
y\_XYZ           & Dataset & 3 (z,y,x) & Cartesian y-coordinate $y=R\cos(\varphi)$\\
z\_XYZ           & Dataset & 3 (z,y,x) & Cartesian z-coordinate $z=Z$ \\
Psip             & Dataset & 3 (z,y,x) & Flux function $\psi_p(R,Z)$ \\
Nprof            & Dataset & 3 (z,y,x) & Density profile $n_\text{prof}$ \\
Source           & Dataset & 3 (z,y,x) & Source  profile $\Theta(\rho_{\max} - \rho(R,Z)) H(Z-Z_X)$\\
BR               & Dataset & 3 (z,y,x) & Contravariant magnetic field component $B^R$ \\
BZ               & Dataset & 3 (z,y,x) & Contravariant magnetic field component $B^Z$ \\
BP               & Dataset & 3 (z,y,x) & Contravariant magnetic field component $B^\varphi$ \\
time             & Dataset & 1 & time at which fields are written (size: maxout$+1$ \\
electrons        & Dataset & 4 (time, z, y, x) & electron density $n_e$ \\
ions             & Dataset & 4 (time, z, y, x) & ion density $N_i$ \\
Ue               & Dataset & 4 (time, z, y, x) & electron velocity $u_e$ \\
Ui               & Dataset & 4 (time, z, y, x) & ion velocity $U_i$ \\
potential        & Dataset & 4 (time, z, y, x) & electric potential $\phi$ \\
induction        & Dataset & 4 (time, z, y, x) & parallel vector potential $A_\parallel$ \\
energy\_time     & Dataset & 1 & timesteps at which 1d variables are written (size: itstp$\cdot$maxout$+1$ \\
mass      & Dataset & 1 (energy\_time) & total mass integral Eq.~\eqref{eq:mass_conservation} \\
diff      & Dataset & 1 (energy\_time) & total mass integral diffusion Eq.~\eqref{eq:mass_conservation} \\
energy    & Dataset & 1 (energy\_time) & total energy integral Eq.~\eqref{eq:energy_conservation} \\
ediff     & Dataset & 1 (energy\_time) & total energy integral diffusion Eq.~\eqref{eq:energy_conservation} \\
Se        & Dataset & 1 (energy\_time) & total electron entropy integral Eq.~\eqref{eq:energy_conservation} \\
Si        & Dataset & 1 (energy\_time) & total ion entropy integral Eq.~\eqref{eq:energy_conservation} \\
Upare        & Dataset & 1 (energy\_time) & total electron parallel energy integral Eq.~\eqref{eq:energy_conservation} \\
Upari        & Dataset & 1 (energy\_time) & total ion parallel energy integral Eq.~\eqref{eq:energy_conservation} \\
Uperp     & Dataset & 1 (energy\_time) & total perpendicular energy integral Eq.~\eqref{eq:energy_conservation} \\
Apar     & Dataset & 1 (energy\_time) & total magnetic energy integral Eq.~\eqref{eq:energy_conservation} \\
dEdt      & Dataset & 1 (energy\_time) & change of energy per time  \\
accuracy  & Dataset & 1 (energy\_time) & accuracy of energy theorem in time  \\
aligned   & Dataset & 1 (energy\_time) & Alignment paramter $\int\dV \ln n_e\Delta_\parallel n_e$\\
\bottomrule
\end{longtable}


%..................................................................
\bibliography{../../doc/related_pages/references}
%..................................................................


\end{document}
