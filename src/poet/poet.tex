%%%%%%%%%%%%%%%%%%%%%definitions%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{../../doc/related_pages/header.tex}
\input{../../doc/related_pages/newcommands.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%DOCUMENT%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{The poet project}
\author{M.~Held}
\maketitle

\begin{abstract}
  This is a program for 2d isothermal delta-f and full-f gyro-fluid simulations with different treatments of the polarization charge
\end{abstract}

\section{Equations}
Currently we implemented $5$ slightly different sets of equations. $n$ is the electron density, $N$ is the ion gyrocentre density. $\phi$ is the electric potential. We
use Cartesian coordinates $x$, $y$.
\subsection{Models}


The two delta-f models ("df" \& "df-O2") share the same evolution equations\footnote{The densities are for delta-f models are understood as fluctuating quantities with respect to a background} 
\begin{subequations}
\begin{align}
%  -\Delta_{\perp} \phi =  \Gamma_1 N -n, \\
\psi = \Gamma_1 \phi \quad \Gamma_1 = ( 1- 0.5\tau\Delta_{\perp})^{-1} \\
 \frac{\partial n}{\partial t}     = 
    \{ n, \phi\} 
  + \kappa \frac{\partial \phi}{\partial y} 
  -\kappa \frac{\partial n}{\partial y}
  + \nu \Delta_{\perp} n  \\
  \frac{\partial N}{\partial t} =
  \{ N, \psi\} 
  + \kappa \frac{\partial \psi}{\partial y} 
  + \tau \kappa\frac{\partial N}{\partial y} +\nu\Delta_{\perp}N
\end{align}
\end{subequations}
and differ only in the polarization equation:\\

"df"
\begin{subequations}
\begin{align}
 -\Delta_{\perp} \phi =  \Gamma_1 N -n, 
%  \\
% \psi = \Gamma_1 \phi \quad \Gamma_1 = ( 1- 0.5\tau\Delta_{\perp})^{-1} \\
%  \frac{\partial n}{\partial t}     = 
%     \{ n, \phi\} 
%   + \kappa \frac{\partial \phi}{\partial y} 
%   -\kappa \frac{\partial n}{\partial y}
%   + \nu \Delta_{\perp} n  \\
%   \frac{\partial N}{\partial t} =
%   \{ N, \psi\} 
%   + \kappa \frac{\partial \psi}{\partial y} 
%   + \tau \kappa\frac{\partial N}{\partial y} +\nu\Delta_{\perp}N
\end{align}
\end{subequations}

"df-O2"
\begin{subequations}
\begin{align}
 -\Gamma_0\Delta_{\perp} \phi =  \Gamma_1 N -n, \quad \Gamma_0 = ( 1- \tau\Delta_{\perp})^{-1} 
%  \\
% \psi = \Gamma_1 \phi 
% \quad \Gamma_1 = ( 1- 0.5\tau\Delta_{\perp})^{-1}  \\
%  \frac{\partial n}{\partial t}     = 
%     \{ n, \phi\} 
%   + \kappa \frac{\partial \phi}{\partial y} 
%   -\kappa \frac{\partial n}{\partial y}
%   + \nu \Delta_{\perp} n  \\
%   \frac{\partial N}{\partial t} =
%   \{ N, \psi\} 
%   + \kappa \frac{\partial \psi}{\partial y} 
%   + \tau \kappa\frac{\partial N}{\partial y} +\nu\Delta_{\perp}N
\end{align}
\end{subequations}
Likewise the full-f models ("ff-lwl" \& "ff-O2" \& "ff-O4") share the same evolution equations
\begin{subequations}
\begin{align}
B(x)^{-1} = \kappa x +1-\kappa X \\ 
% \quad \Gamma_1 = ( 1- 0.5\tau\Delta_{\perp})^{-1}\\
%  -\nabla\cdot \left(\frac{N}{B^2} \nabla_\perp \phi\right) = \Gamma_1 N-n, \\
% \psi = \Gamma_1 \phi - \frac{1}{2} \frac{(\nabla\phi)^2}{B^2}\\
 \frac{\partial n}{\partial t}     = 
    \frac{1}{B}\{ n, \phi\} 
  + \kappa n\frac{\partial \phi}{\partial y} 
  -\kappa \frac{\partial n}{\partial y}
  + \nu \nabla_\perp^2 n  \\
  \frac{\partial N}{\partial t} =
  \frac{1}{B}\{ N, \psi\} 
  + \kappa N\frac{\partial \psi}{\partial y} 
  + \tau \kappa\frac{\partial N}{\partial y} +\nu\nabla_\perp^2N
\end{align}
\end{subequations}
and differ only in the treatment of the FLR and polarization terms:\\
"ff-lwl" 
\begin{subequations}
\begin{align}
% B(x)^{-1} = \kappa x +1-\kappa X\quad 
\Gamma_1 = ( 1- 0.5\tau\Delta_{\perp})^{-1}\\
 -\nabla\cdot \left(\frac{N}{B^2} \nabla_\perp \phi\right) = \Gamma_1 N-n, \\
\psi = \Gamma_1 \phi - \frac{1}{2} \frac{(\nabla\phi)^2}{B^2}\\
%  \frac{\partial n}{\partial t}     = 
%     \frac{1}{B}\{ n, \phi\} 
%   + \kappa n\frac{\partial \phi}{\partial y} 
%   -\kappa \frac{\partial n}{\partial y}
%   + \nu \nabla_\perp^2 n  \\
%   \frac{\partial N}{\partial t} =
%   \frac{1}{B}\{ N, \psi\} 
%   + \kappa N\frac{\partial \psi}{\partial y} 
%   + \tau \kappa\frac{\partial N}{\partial y} +\nu\nabla_\perp^2N
\end{align}
\end{subequations}


"ff-O2"
\begin{subequations}
\begin{align}
% B(x)^{-1} = \kappa x +1-\kappa X\quad 
\Gamma_1 = \sqrt{1- \tau\Delta_{\perp}}^{-1}\\
 -\Gamma_1\nabla\cdot \left(\frac{N}{B^2} \nabla_\perp\Gamma_1 \phi\right) = \Gamma_1 N-n,  \\
\psi = \Gamma_1 \phi - \frac{1}{2} \frac{(\nabla \Gamma_1\phi)^2}{B^2}
% \\
%  \frac{\partial n}{\partial t}     = 
%     \frac{1}{B}\{ n, \phi\} 
%   + \kappa n\frac{\partial \phi}{\partial y} 
%   -\kappa \frac{\partial n}{\partial y}
%   + \nu \nabla_\perp^2 n  \\
%   \frac{\partial N}{\partial t} =
%   \frac{1}{B}\{ N, \psi\} 
%   + \kappa N\frac{\partial \psi}{\partial y} 
%   + \tau \kappa\frac{\partial N}{\partial y} +\nu\nabla_\perp^2N
\end{align}
\end{subequations}

"ff-O4"
\begin{subequations}
\begin{align}
% B(x)^{-1} = \kappa x +1-\kappa X\quad
\Gamma_1 = (1- \tau/2\Delta_{\perp})^{-1}\\
 -\Gamma_1 \left[\nabla\cdot \left(\frac{N}{B^2} \nabla_\perp\right)-2   \nabla\cdot\nabla\cdot \left(\frac{\tau N}{B^4} \nabla_\perp^2\right)+  \Delta_{\perp} \left(\frac{\tau N}{B^4} \Delta_{\perp}\right)\right]\Gamma_1 \phi = \Gamma_1 N-n,  \\
\psi = \Gamma_1 \phi - \frac{1}{2 B^2} \left[|\nabla_\perp \Gamma_1\phi|^2 + \frac{\tau}{2 B^2} \left[|\nabla_\perp^2 \Gamma_1\phi |^2 - (\Delta_{\perp} \Gamma_1\phi)^2 /2 \right]\right]
% \\
%  \frac{\partial n}{\partial t}     = 
%     \frac{1}{B}\{ n, \phi\} 
%   + \kappa n\frac{\partial \phi}{\partial y} 
%   -\kappa \frac{\partial n}{\partial y}
%   + \nu \nabla_\perp^2 n  \\
%   \frac{\partial N}{\partial t} =
%   \frac{1}{B}\{ N, \psi\} 
%   + \kappa N\frac{\partial \psi}{\partial y} 
%   + \tau \kappa\frac{\partial N}{\partial y} +\nu\nabla_\perp^2N
\end{align}
\end{subequations}

\subsection{Initialization}
We follow the strategy to enforce the initial fields of the physical variables, the electron density \(n\) and the electric potential \(\phi\), in order to compute the initial ion gyro-center density.
\subsubsection{Non-rotating Gaussian}
Initialization of $n$ is a Gaussian 
\begin{align}
    n(x,y) &= 1 + A\exp\left( -\frac{(x-X)^2 + (y-Y)^2}{2\sigma^2}\right) \\
    \phi(x,y)&=const.
\end{align}
where $X = p_x l_x$ and $Y=p_yl_y$ are the initial centre of mass position coordinates, $A$ is the amplitude and $\sigma$ the
radius of the blob.
We initialize 
\begin{align}
    N &= \Gamma_1^{-1} n 
\end{align}
\subsubsection{Rotating Gaussian}
\begin{align}
    n(x,y) &= 1 + A\exp\left( -\frac{(x-X)^2 + (y-Y)^2}{2\sigma^2}\right) \\
    \Omega_E:= \vec{\nabla} \cdot \left(\frac{1}{B} \vec{\nabla}_\perp \phi\right) &= \delta \hspace{1mm} (n-1)
\end{align}
where \(\delta\) is a parameter for the rotation
Thus we have
\begin{align}
  \phi(x,y) &= \Delta_\perp^{-1} \Omega_E = \dots \\
  \partial_x \phi &= \dots \\
   \partial_y \phi &= \dots
\end{align}

the ion gyro-center density follows from the respective polarization equation.

\subsubsection{Shear flow (double shear layer)}
\begin{align}
 n(x,y) &= n_{e0}\\
    \Omega_E:= \vec{\nabla} \cdot \left(\frac{1}{B} \vec{\nabla}_\perp \phi\right) &= A
    \begin{cases}
        \delta \cos(2 \pi y/l_y) - \frac{1}{\rho} \text{sech}^2 \left(\frac{2 \pi x/l_x-\pi/2}{\rho}\right),\ x \leq l_x/2 \\
        \delta \cos(2 \pi y/l_y) + \frac{1}{\rho} \text{sech}^2 \left(\frac{3 \pi /2-2 \pi x/l_x}{\rho}\right),\ x > l_x/2 \\
    \end{cases}
%  \phi(x,y) &= \dots \\
\end{align}
where \(\rho=\pi/15\) is the width of the shear layer and \(\delta=0.05\). The A parameter serves to control the magnitude.
\begin{align}
  \phi(x,y) &= \Delta_\perp^{-1} \Omega_E
\end{align}
the ion gyro-center density follows from the respective polarization equation, which requires a non-linear solve \(f(N,\phi) = n_e\). An initial guess for the ion gyro-cente rdensity \(N\) is obtained via the lwl approximated polarization equation.

\subsection{Diagnostics}
\begin{align}
    M(t) = \int n-1 \\
%     \Lambda_n = \nu \int \Delta n  \\
    ...
    \label{}
\end{align}
\section{Numerical methods}
discontinuous Galerkin on structured grid
\rowcolors{2}{gray!25}{white} %%% Use this line in front of longtable
\begin{longtable}{ll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Term} &  \textbf{Method} & \textbf{Description}  \\ \midrule
coordinate system & Cartesian 2D & equidistant discretization of $[0,l_x] \times [0,l_y]$, equal number of Gaussian nodes in x and y \\
matrix inversions & multigrid conjugate gradient &  \\
matrix functions & cauchy integral  method & \\
\ExB advection & centered upwind-scheme\\
curvature terms & centered difference & \\
time &  Karniadakis multistep & $3rd$ order explicit, diffusion $2nd$ order implicit \\
\bottomrule
\end{longtable}

\section{Compilation and useage}
There are two programs poet.cu and poet\_hpc.cu . Compilation with
\begin{verbatim}
make <poet poet_hpc poet_mpi> device = <omp gpu>
\end{verbatim}
Run with
\begin{verbatim}
path/to/feltor/src/poet/poet input.json
path/to/feltor/src/poet/poet_hpc input.json output.nc
echo np_x np_y | mpirun -n np_x*np_y path/to/feltor/src/poet/poet_mpi\
    input.json output.nc
\end{verbatim}
All programs write performance informations to std::cout.
The first is for shared memory systems (OpenMP/GPU) and opens a terminal window with life simulation results.
 The
second can be compiled for both shared and distributed memory systems and uses serial netcdf in both cases
to write results to a file.
For distributed
memory systems (MPI+OpenMP/GPU) the program expects the distribution of processes in the
x and y directions as command line input parameters.

\subsection{Input file structure}
Input file format: json

%%This is a booktabs table
\begin{longtable}{llll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Example} & \textbf{Default} & \textbf{Description}  \\ \midrule
n      & integer & 3 & - &\# Gaussian nodes in x and y \\
Nx     & integer &100& - &\# grid points in x \\
Ny     & integer &100& - &\# grid points in y \\
dt     & integer &3.0& - &time step in units of $c_s/\rho_s$ \\
n\_out  & integer &3  & - &\# Gaussian nodes in x and y in output \\
Nx\_out & integer &100& - &\# grid points in x in output fields \\
Ny\_out & integer &100& - &\# grid points in y in output fields \\
itstp  & integer &2  & - &   steps between outputs \\
maxout & integer &100& - &      \# outputs excluding first \\
eps\_pol   & float &1e-6    & - &  accuracy of polarisation solver \\
eps\_gamma & float &1e-7    & - & accuracy of $\Gamma_1$ (should be slightly smaller than eps\_pol) \\
eps\_time  & float &1e-10   & - & accuracy of implicit time-stepper \\
curvature  & float &0.00015& - & magnetic curvature $\kappa$ \\
tau        & float &1      & - & $\tau = T_i/T_e$ (only in gyrofluid models) \\
nu\_perp    & float &5e-3   & - & pependicular viscosity $\nu$ \\
amplitude  & float &1.0    & - & amplitude $A$ of the blob \\
sigma      & float &10     & - & blob radius $\sigma$ \\
posX       & float &0.3    & - & blob x-position in units of $l_x$, i.e. $X = p_x l_x$\\
posY       & float &0.5    & - & blob y-position in units of $l_y$, i.e. $Y = p_y l_y$ \\
lx         & float &200    & - & $l_x$  \\
ly         & float &200    & - & $l_y$  \\
bc\_x   & char & "DIR"      & - & boundary condition in x (one of PER, DIR, NEU, DIR\_NEU or NEU\_DIR) \\
bc\_y   & char & "PER"      & - & boundary condition in y (one of PER, DIR, NEU, DIR\_NEU or NEU\_DIR) \\
equations  & char & "ff-lwl" & "ff-lwl" &df, df-O2, ff, ff-O2, ff-O4\\
\bottomrule
\end{longtable}

The default value is taken if the value name is not found in the input file. If there is no default and
the value is not found,
the program exits with an error message.

\subsection{Structure of output file}
Output file format: netcdf-4/hdf5
%
%Name | Type | Dimensionality | Description
%---|---|---|---|
\begin{longtable}{lll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Dimension} & \textbf{Description}  \\ \midrule
inputfile  &             text attribute & 1 & verbose input file as a string \\
energy\_time             & Dataset & 1 & timesteps at which 1d variables are written \\
time                     & Dataset & 1 & time at which fields are written \\
x                        & Dataset & 1 & x-coordinate  \\
y                        & Dataset & 1 & y-coordinate \\
electrons                & Dataset & 3 (time, y, x) & electon density $n$ \\
ions                     & Dataset & 3 (time, y, x) & ion density $N$ or vorticity density $\rho$  \\
potential                & Dataset & 3 (time, y, x) & electric potential $\phi$  \\
vorticity                & Dataset & 3 (time, y, x) & Laplacian of potential $\Delta_{\perp}\phi$  \\
dEdt                     & Dataset & 1 (energy\_time) & change of energy per time  \\
dissipation              & Dataset & 1 (energy\_time) & diffusion integrals  \\
energy                   & Dataset & 1 (energy\_time) & total energy integral  \\
mass                     & Dataset & 1 (energy\_time) & mass integral   \\
\bottomrule
\end{longtable}
%..................................................................
\bibliography{../../doc/related_pages/references}
%..................................................................


\end{document}
